<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Dede Evi">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1a1a2e">
    <meta name="description" content="Dedenin Gizemli Evi - Bulmaca ve Kacis Macerasi">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon.svg">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Dede'nin Gizemli Evi</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&family=Press+Start+2P&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --pixel-size: 4px;
            --bg-dark: #1a1a2e;
            --bg-darker: #0f0f1a;
            --purple: #6b5b95;
            --purple-dark: #4a3f6b;
            --gold: #f4d03f;
            --gold-dark: #c9a227;
            --teal: #45b7aa;
            --pale: #e8e8e8;
            --wood: #8b7355;
            --wood-dark: #5c4d3a;
        }
        
        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            touch-action: none;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
        }
        
        body {
            font-family: 'VT323', monospace;
            background: var(--bg-darker);
            color: var(--pale);
            image-rendering: pixelated;
        }
        
        #game-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-dark);
            overflow: hidden;
        }
        
        /* ===== INTRO ===== */
        #intro-screen {
            position: absolute;
            inset: 0;
            background: linear-gradient(180deg, #1a1a2e 0%, #0f0f1a 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 200;
            padding: 20px;
            text-align: center;
        }
        #intro-screen.hidden { display: none; }
        
        .story-title {
            font-family: 'Press Start 2P', monospace;
            font-size: clamp(16px, 5vw, 24px);
            color: var(--gold);
            text-shadow: 0 0 20px rgba(244,208,63,0.5), 2px 2px 0 #000;
            margin-bottom: 25px;
            animation: glow 2s ease-in-out infinite;
        }
        
        @keyframes glow {
            0%, 100% { text-shadow: 0 0 20px rgba(244,208,63,0.5), 2px 2px 0 #000; }
            50% { text-shadow: 0 0 30px rgba(244,208,63,0.8), 2px 2px 0 #000; }
        }
        
        .story-text {
            max-width: 500px;
            font-size: clamp(14px, 4vw, 18px);
            line-height: 1.8;
            color: var(--pale);
            margin-bottom: 25px;
        }
        .story-text .highlight {
            color: var(--gold);
            font-weight: bold;
        }
        
        .continue-btn {
            font-family: 'Press Start 2P', monospace;
            font-size: clamp(10px, 3vw, 12px);
            padding: 15px 30px;
            background: linear-gradient(180deg, var(--purple), var(--purple-dark));
            border: 3px solid var(--gold);
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            -webkit-tap-highlight-color: transparent;
        }
        .continue-btn:hover, .continue-btn:active {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(244,208,63,0.5);
        }
        
        /* ===== MENU ===== */
        #menu {
            position: absolute;
            inset: 0;
            display: none;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            background: linear-gradient(180deg, #1a1a2e 0%, #0f0f1a 100%);
            z-index: 100;
            overflow-y: auto;
        }
        #menu.active { display: flex; }
        
        .game-title {
            font-family: 'Press Start 2P', monospace;
            font-size: clamp(12px, 4vw, 18px);
            color: var(--gold);
            text-shadow: 0 0 20px rgba(244,208,63,0.5), 2px 2px 0 #000;
            margin-bottom: 5px;
            text-align: center;
        }
        
        .game-subtitle {
            font-size: clamp(12px, 3vw, 16px);
            color: var(--teal);
            margin-bottom: 20px;
        }
        
        .menu-section {
            margin-bottom: 15px;
            text-align: center;
            width: 100%;
            max-width: 500px;
        }
        
        .section-title {
            font-size: 14px;
            color: #888;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        
        .char-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            justify-content: center;
            max-width: 400px;
        }
        
        @media (max-width: 400px) {
            .char-grid { 
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
            }
        }
        
        .char-card {
            background: linear-gradient(180deg, #2a2a4e, #1a1a2e);
            border: 3px solid #3a3a5e;
            padding: 12px 8px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            -webkit-tap-highlight-color: transparent;
        }
        .char-card:hover, .char-card:active {
            border-color: var(--teal);
            transform: translateY(-2px);
        }
        .char-card.selected {
            border-color: var(--gold);
            background: linear-gradient(180deg, #3a3a5e, #2a2a4e);
            box-shadow: 0 0 15px rgba(244,208,63,0.3);
        }
        
        .char-sprite {
            font-size: 32px;
            margin-bottom: 8px;
        }
        .char-name {
            font-family: 'Press Start 2P', monospace;
            font-size: 8px;
            color: var(--gold);
            margin-bottom: 4px;
        }
        .char-stats {
            font-size: 11px;
            color: #aaa;
        }
        
        .chapter-select {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .chapter-btn {
            padding: 10px 16px;
            font-family: 'VT323', monospace;
            font-size: 16px;
            background: #2a2a4e;
            border: 2px solid #3a3a5e;
            color: var(--pale);
            cursor: pointer;
            transition: all 0.2s;
            -webkit-tap-highlight-color: transparent;
        }
        .chapter-btn:hover { border-color: var(--teal); }
        .chapter-btn.selected {
            border-color: var(--gold);
            background: #3a3a5e;
            color: var(--gold);
        }
        .chapter-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        
        .start-btn {
            font-family: 'Press Start 2P', monospace;
            font-size: clamp(10px, 3vw, 14px);
            padding: 15px 35px;
            background: linear-gradient(180deg, var(--teal), #2a8a7f);
            border: 3px solid var(--gold);
            color: white;
            cursor: pointer;
            margin-top: 15px;
            transition: all 0.2s;
            -webkit-tap-highlight-color: transparent;
        }
        .start-btn:hover:not(:disabled), .start-btn:active:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 0 25px rgba(69,183,170,0.5);
        }
        .start-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        #highscore {
            margin-top: 15px;
            color: var(--gold);
            font-size: 14px;
        }
        
        /* ===== GAME ===== */
        #game {
            position: absolute;
            inset: 0;
            display: none;
        }
        #game.active { display: block; }
        
        .hud {
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 50px;
            background: linear-gradient(180deg, #1a1a2e, #0f0f1a);
            border-bottom: 3px solid #3a3a5e;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 10px;
            z-index: 50;
            flex-wrap: wrap;
        }
        
        .hud-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .hud-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
        }
        
        .pixel-bar {
            width: 60px;
            height: 10px;
            background: #1a1a1a;
            border: 2px solid #3a3a3a;
            overflow: hidden;
        }
        .pixel-bar-fill {
            height: 100%;
            transition: width 0.3s;
        }
        .health-fill { background: linear-gradient(90deg, #e74c3c, #c0392b); }
        .energy-fill { background: linear-gradient(90deg, var(--teal), #2a8a7f); }
        
        .chapter-indicator {
            font-family: 'Press Start 2P', monospace;
            font-size: 8px;
            color: var(--purple);
        }
        
        .room-name {
            font-size: 16px;
            color: var(--gold);
            display: none;
        }
        @media (min-width: 500px) {
            .room-name { display: block; }
        }
        
        .timer {
            font-family: 'Press Start 2P', monospace;
            font-size: 10px;
            color: var(--pale);
        }
        
        .hud-stat { font-size: 14px; }
        
        .pause-btn {
            background: none;
            border: 2px solid #3a3a5e;
            padding: 5px 10px;
            color: var(--pale);
            cursor: pointer;
            font-size: 16px;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* ===== GAME AREA ===== */
        #game-area {
            position: absolute;
            top: 50px;
            left: 0;
            right: 0;
            bottom: 0;
            overflow: hidden;
        }
        
        @media (max-width: 768px), (pointer: coarse) {
            #game-area { bottom: 130px; }
        }
        
        @media (max-width: 480px) {
            #game-area { bottom: 120px; }
        }
        
        #room {
            position: absolute;
            inset: 0;
            image-rendering: pixelated;
        }
        
        /* Room backgrounds - cozy mysterious style */
        .room-salon { 
            background: 
                radial-gradient(ellipse at 20% 20%, rgba(107,91,149,0.1) 0%, transparent 50%),
                linear-gradient(180deg, #2d2d4a 0%, #1a1a30 100%); 
        }
        .room-mutfak { 
            background: 
                radial-gradient(ellipse at 80% 30%, rgba(69,183,170,0.08) 0%, transparent 50%),
                linear-gradient(180deg, #2a3d4a 0%, #1a2530 100%); 
        }
        .room-yatak { 
            background: 
                radial-gradient(ellipse at 50% 50%, rgba(149,91,107,0.1) 0%, transparent 50%),
                linear-gradient(180deg, #3d2d4a 0%, #251a30 100%); 
        }
        .room-bodrum { 
            background: 
                radial-gradient(ellipse at 30% 70%, rgba(80,80,100,0.1) 0%, transparent 50%),
                linear-gradient(180deg, #252535 0%, #151520 100%); 
        }
        
        .room-floor {
            position: absolute;
            bottom: 0; left: 0; right: 0;
            height: 120px;
            background: 
                repeating-linear-gradient(90deg, 
                    #5a4a3a 0px, #5a4a3a 40px,
                    #6a5a4a 40px, #6a5a4a 80px
                );
            border-top: 4px solid #3a2a1a;
            image-rendering: pixelated;
        }
        
        .room-floor::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: 
                repeating-linear-gradient(90deg,
                    transparent 0px,
                    transparent 39px,
                    rgba(0,0,0,0.2) 39px,
                    rgba(0,0,0,0.2) 41px,
                    transparent 41px,
                    transparent 80px
                );
        }
        
        /* Duvar s√ºsleri */
        .room-wall-decor {
            position: absolute;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 40px;
            opacity: 0.15;
            filter: blur(1px);
        }
        
        .furniture {
            position: absolute;
            image-rendering: pixelated;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            border: 3px solid;
            border-color: #7a6a5a #4a3a2a #4a3a2a #7a6a5a;
            box-shadow: 
                inset -4px -4px 0 rgba(0,0,0,0.4),
                inset 4px 4px 0 rgba(255,255,255,0.15),
                2px 4px 8px rgba(0,0,0,0.3);
            transition: box-shadow 0.3s;
        }
        
        .furniture::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            right: 50%;
            height: 3px;
            background: linear-gradient(90deg, rgba(255,255,255,0.2), transparent);
        }
        
        .furniture.hideable {
            cursor: pointer;
        }
        
        .furniture.hideable:hover {
            box-shadow: 
                inset -4px -4px 0 rgba(0,0,0,0.4),
                inset 4px 4px 0 rgba(255,255,255,0.15),
                0 0 20px rgba(69,183,170,0.5),
                2px 4px 8px rgba(0,0,0,0.3);
        }
        
        .door {
            position: absolute;
            background: linear-gradient(180deg, #7a6a5a, #5a4a3a);
            border: 4px solid;
            border-color: #9a8a7a #4a3a2a #4a3a2a #9a8a7a;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            z-index: 10;
            box-shadow: 
                inset -4px -4px 0 rgba(0,0,0,0.3),
                inset 4px 4px 0 rgba(255,255,255,0.1),
                4px 4px 10px rgba(0,0,0,0.4);
        }
        .door::before {
            content: '';
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 8px;
            height: 8px;
            background: radial-gradient(circle, var(--gold), #aa8800);
            border-radius: 50%;
            box-shadow: 0 0 6px var(--gold);
        }
        .door::after {
            content: '';
            position: absolute;
            top: 10%;
            left: 15%;
            right: 15%;
            bottom: 55%;
            background: rgba(0,0,0,0.2);
            border: 2px solid rgba(0,0,0,0.3);
        }
        .door-label {
            font-size: 8px;
            color: rgba(255,255,255,0.7);
            margin-top: 4px;
            text-shadow: 1px 1px 1px rgba(0,0,0,0.5);
        }
        
        .door.exit {
            background: linear-gradient(180deg, #4a7a5a, #3a5a4a);
            border-color: #6a9a7a #2a4a3a #2a4a3a #6a9a7a;
            box-shadow: 
                inset -4px -4px 0 rgba(0,0,0,0.3),
                inset 4px 4px 0 rgba(255,255,255,0.1),
                0 0 15px rgba(69,183,170,0.3),
                4px 4px 10px rgba(0,0,0,0.4);
        }
        .door.exit.locked {
            background: linear-gradient(180deg, #6a5050, #4a3535);
            border-color: #8a7070 #3a2525 #3a2525 #8a7070;
            box-shadow: 
                inset -4px -4px 0 rgba(0,0,0,0.3),
                inset 4px 4px 0 rgba(255,255,255,0.1),
                4px 4px 10px rgba(0,0,0,0.4);
        }
        .door.exit.locked::after {
            content: 'üîí';
            position: absolute;
            font-size: 14px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: none;
            border: none;
        }
        
        .puzzle-obj {
            position: absolute;
            font-size: 28px;
            z-index: 15;
            filter: drop-shadow(0 0 8px rgba(244,208,63,0.5));
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-6px); }
        }
        
        .clue-obj {
            position: absolute;
            font-size: 24px;
            z-index: 15;
            filter: drop-shadow(0 0 6px rgba(69,183,170,0.6));
            animation: float 2.5s ease-in-out infinite;
        }
        
        .player {
            position: absolute;
            width: 32px;
            height: 48px;
            z-index: 40;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 26px;
            filter: drop-shadow(2px 3px 2px rgba(0,0,0,0.5));
            transition: opacity 0.2s, transform 0.1s;
        }
        .player.hiding { 
            opacity: 0.3; 
            transform: scale(0.9);
        }
        .player.hurt { 
            animation: hurtBlink 0.12s linear 4; 
        }
        
        @keyframes hurtBlink {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.3; transform: scale(1.1); filter: brightness(1.8) drop-shadow(0 0 10px #ff6666); }
        }
        
        .grandpa {
            position: absolute;
            width: 40px;
            height: 56px;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            z-index: 35;
            filter: drop-shadow(2px 3px 2px rgba(0,0,0,0.5));
            transition: filter 0.3s;
        }
        .grandpa.visible { display: flex; }
        .grandpa.chasing {
            animation: grandpaChase 0.2s infinite;
            filter: 
                drop-shadow(2px 3px 2px rgba(0,0,0,0.5))
                drop-shadow(0 0 12px rgba(107,91,149,0.7));
        }
        
        @keyframes grandpaChase {
            0%, 100% { transform: translateY(0) rotate(-2deg); }
            50% { transform: translateY(-4px) rotate(2deg); }
        }
        
        .msg {
            position: absolute;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(15,15,26,0.95);
            border: 2px solid var(--purple);
            padding: 10px 20px;
            font-size: 14px;
            display: none;
            z-index: 60;
            max-width: 90%;
            text-align: center;
        }
        .msg.show { display: block; animation: msgPop 0.3s; }
        
        @keyframes msgPop {
            from { opacity: 0; transform: translateX(-50%) scale(0.9); }
            to { opacity: 1; transform: translateX(-50%) scale(1); }
        }
        
        .minimap {
            position: absolute;
            bottom: 10px;
            right: 10px;
            width: 80px;
            height: 65px;
            background: rgba(15,15,26,0.9);
            border: 2px solid #3a3a5e;
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 2px;
            padding: 3px;
            z-index: 50;
        }
        
        @media (max-width: 400px) {
            .minimap { display: none; }
        }
        
        .map-room {
            background: #2a2a4e;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 7px;
            color: #666;
        }
        .map-room.current {
            background: var(--purple-dark);
            color: white;
        }
        .map-room.has-grandpa::after {
            content: 'üëÄ';
            font-size: 8px;
        }
        
        .controls-hint {
            position: absolute;
            bottom: 8px;
            left: 10px;
            font-size: 10px;
            color: #444;
        }
        
        @media (max-width: 600px) {
            .controls-hint { display: none; }
        }
        
        #fog {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 45;
            background: radial-gradient(ellipse at center, transparent 40%, rgba(15,15,26,0.3) 100%);
        }
        
        /* ===== MOBILE CONTROLS ===== */
        #mobile-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 130px;
            background: linear-gradient(180deg, rgba(26,26,46,0.95), rgba(15,15,26,0.98));
            border-top: 3px solid #3a3a5e;
            display: none;
            justify-content: space-between;
            align-items: center;
            padding: 10px 25px;
            z-index: 80;
        }
        
        @media (max-width: 768px), (pointer: coarse) {
            #mobile-controls { display: flex; }
            #game-area { bottom: 130px; }
            .controls-hint { display: none; }
            .minimap { 
                width: 70px; 
                height: 55px; 
                bottom: 5px;
                right: 5px;
            }
            .map-room { font-size: 6px; }
        }
        
        @media (max-width: 480px) {
            #mobile-controls { 
                height: 120px;
                padding: 8px 15px;
            }
            #game-area { bottom: 120px; }
            .hud { 
                height: 45px; 
                padding: 0 8px;
            }
            .hud-item { gap: 3px; }
            .pixel-bar { width: 50px; height: 8px; }
            .timer { font-size: 9px; }
            .chapter-indicator { font-size: 7px; }
        }
        
        #joystick-zone {
            width: 110px;
            height: 110px;
            background: rgba(58,58,94,0.6);
            border: 3px solid #5a5a7e;
            border-radius: 50%;
            position: relative;
            touch-action: none;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
            flex-shrink: 0;
        }
        
        #joystick-knob {
            width: 50px;
            height: 50px;
            background: linear-gradient(145deg, var(--teal), #2a8a7f);
            border: 3px solid var(--gold);
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        
        .mobile-btns {
            display: flex;
            gap: 15px;
            flex-shrink: 0;
        }
        
        .mobile-btn {
            width: 65px;
            height: 65px;
            border-radius: 50%;
            border: 3px solid;
            font-size: 26px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            user-select: none;
            transition: transform 0.1s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        
        .mobile-btn:active {
            transform: scale(0.9);
        }
        
        #btn-action {
            background: linear-gradient(145deg, var(--purple), var(--purple-dark));
            border-color: var(--gold);
        }
        
        #btn-run {
            background: linear-gradient(145deg, var(--teal), #2a8a7f);
            border-color: var(--gold);
        }
        
        @media (max-width: 480px) {
            #joystick-zone {
                width: 95px;
                height: 95px;
            }
            #joystick-knob {
                width: 42px;
                height: 42px;
            }
            .mobile-btn {
                width: 55px;
                height: 55px;
                font-size: 22px;
            }
            .mobile-btns { gap: 10px; }
        }
        
        /* ===== MODALS ===== */
        .modal {
            position: absolute;
            inset: 0;
            display: none;
            justify-content: center;
            align-items: center;
            background: rgba(0,0,0,0.9);
            z-index: 500;
            padding: 15px;
        }
        .modal.active { display: flex; }
        
        .modal-box {
            background: linear-gradient(180deg, #2a2a4e, #1a1a2e);
            border: 3px solid var(--purple);
            padding: 25px;
            text-align: center;
            max-width: 95%;
            max-height: 90%;
            overflow-y: auto;
        }
        
        .modal-title {
            font-family: 'Press Start 2P', monospace;
            font-size: clamp(10px, 3vw, 14px);
            color: var(--gold);
            margin-bottom: 15px;
        }
        
        .modal-text {
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 15px;
            color: var(--pale);
        }
        
        .modal-input {
            width: 100%;
            max-width: 200px;
            padding: 14px;
            font-family: 'VT323', monospace;
            font-size: 24px;
            text-align: center;
            background: #0f0f1a;
            border: 2px solid #3a3a5e;
            color: var(--gold);
            margin-bottom: 12px;
            border-radius: 4px;
            -webkit-appearance: none;
            appearance: none;
        }
        .modal-input:focus {
            outline: none;
            border-color: var(--teal);
            box-shadow: 0 0 10px rgba(69,183,170,0.3);
        }
        
        /* Mobil i√ßin input ayarlarƒ± */
        @media (max-width: 480px) {
            .modal-input {
                font-size: 20px;
                padding: 12px;
                max-width: 180px;
            }
            .modal-box {
                padding: 20px 15px;
                max-width: 92%;
            }
            .modal-title {
                font-size: 11px;
            }
            .modal-text {
                font-size: 15px;
            }
            .btn {
                font-size: 15px;
                padding: 10px 16px;
            }
            .modal-btns {
                gap: 8px;
            }
        }
        
        .modal-btns {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .btn {
            font-family: 'VT323', monospace;
            font-size: 16px;
            padding: 10px 20px;
            border: 2px solid;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }
        
        .btn-teal {
            background: linear-gradient(180deg, var(--teal), #2a8a7f);
            border-color: var(--gold);
            color: white;
        }
        .btn-purple {
            background: linear-gradient(180deg, var(--purple), var(--purple-dark));
            border-color: var(--gold);
            color: white;
        }
        .btn-gray {
            background: linear-gradient(180deg, #444, #2a2a2a);
            border-color: #666;
            color: #aaa;
        }
        
        .feedback {
            font-size: 16px;
            margin: 8px 0;
            min-height: 20px;
        }
        .feedback.correct { color: var(--teal); }
        .feedback.wrong { color: #e74c3c; }
        
        .hint {
            font-size: 14px;
            color: var(--gold);
            margin: 8px 0;
        }
        
        .hiding-modal .modal-box { border-color: var(--teal); }
        .hiding-text {
            font-size: 22px;
            color: var(--teal);
            margin-bottom: 15px;
        }
        .peephole {
            width: 100px;
            height: 100px;
            margin: 0 auto 15px;
            background: radial-gradient(circle, #1a1a2e 0%, #000 70%);
            border: 3px solid #3a3a5e;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
        }
        .hide-warning {
            color: #e74c3c;
            font-size: 16px;
            margin-top: 10px;
            display: none;
        }
        .hide-warning.show { display: block; animation: pulse 0.5s infinite; }
        
        @keyframes pulse {
            50% { opacity: 0.5; }
        }
        
        #chapter-transition {
            position: absolute;
            inset: 0;
            background: #000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 600;
            padding: 20px;
            text-align: center;
        }
        #chapter-transition.active { display: flex; }
        
        .chapter-title {
            font-family: 'Press Start 2P', monospace;
            font-size: clamp(12px, 4vw, 18px);
            color: var(--gold);
            margin-bottom: 15px;
        }
        .chapter-subtitle {
            font-size: 18px;
            color: var(--pale);
        }
        
        .win-title {
            font-family: 'Press Start 2P', monospace;
            font-size: clamp(14px, 4vw, 20px);
            color: var(--teal);
            margin-bottom: 15px;
        }
        .lose-title {
            font-family: 'Press Start 2P', monospace;
            font-size: clamp(14px, 4vw, 20px);
            color: #e74c3c;
            margin-bottom: 15px;
        }
        .score {
            font-family: 'Press Start 2P', monospace;
            font-size: clamp(12px, 3vw, 16px);
            color: var(--gold);
            margin: 15px 0;
        }
        
        .safe-display {
            font-family: 'Press Start 2P', monospace;
            font-size: clamp(18px, 5vw, 24px);
            color: var(--teal);
            background: #0f0f1a;
            padding: 12px 25px;
            margin-bottom: 15px;
            border: 3px solid #3a3a5e;
            letter-spacing: 8px;
        }
        
        .clue-list {
            text-align: left;
            margin: 12px 0;
            padding: 12px;
            background: rgba(0,0,0,0.3);
            border: 1px solid #3a3a5e;
        }
        .clue-item {
            margin: 6px 0;
            font-size: 14px;
        }
        .clue-item.found { color: var(--gold); }
        .clue-item.missing { color: #666; }
    </style>
</head>
<body>
    <div id="game-container">
        <!-- INTRO -->
        <div id="intro-screen">
            <h1 class="story-title">üè† DEDENƒ∞N Gƒ∞ZEMLƒ∞ EVƒ∞</h1>
            <div class="story-text">
                <p>Yƒ±llardƒ±r kapalƒ± olan <span class="highlight">aile malik√¢nesi</span>ne ho≈ü geldin!</p>
                <br>
                <p>Deden <span class="highlight">Necmi</span> burada ya≈üardƒ±. ≈ûimdi ev sana miras kaldƒ± ama i√ßeri girince kapƒ± arkandan kapandƒ±!</p>
                <br>
                <p>Dede biraz <span class="highlight">yaramaz</span> bir ruh... Evde saklamba√ß oynamak istiyor!</p>
                <br>
                <p>Bulmacalarƒ± √ß√∂z, kasanƒ±n ≈üifresini bul, anahtarƒ± al ve evden √ßƒ±k!</p>
                <br>
                <p style="font-size:14px;color:#888;">üß© 3 bulmaca √ß√∂z ‚Üí üîê Kasayƒ± a√ß ‚Üí üîë Anahtarƒ± al ‚Üí üö™ Ka√ß!</p>
            </div>
            <button class="continue-btn" id="continue-intro">MACERAYA BA≈ûLA</button>
        </div>
        
        <!-- MENU -->
        <div id="menu">
            <h1 class="game-title">üè† DEDENƒ∞N Gƒ∞ZEMLƒ∞ EVƒ∞</h1>
            <p class="game-subtitle">‚ú® Bulmaca & Ka√ßƒ±≈ü Macerasƒ± ‚ú®</p>
            
            <div class="menu-section">
                <div class="section-title">Karakterini Se√ß</div>
                <div class="char-grid" id="char-grid"></div>
            </div>
            
            <div class="menu-section">
                <div class="section-title">B√∂l√ºm</div>
                <div class="chapter-select" id="chapter-select"></div>
            </div>
            
            <button class="start-btn" id="start-btn" disabled>üéÆ OYUNA BA≈ûLA</button>
            <div id="highscore"></div>
        </div>
        
        <!-- GAME -->
        <div id="game">
            <div class="hud">
                <div class="hud-group">
                    <div class="hud-item">‚ù§Ô∏è<div class="pixel-bar"><div class="pixel-bar-fill health-fill" id="health-bar" style="width:100%"></div></div></div>
                    <div class="hud-item">‚ö°<div class="pixel-bar"><div class="pixel-bar-fill energy-fill" id="energy-bar" style="width:100%"></div></div></div>
                </div>
                <div class="hud-group">
                    <span class="chapter-indicator" id="chapter-ind">B√ñL√úM 1</span>
                    <span class="room-name" id="room-name">SALON</span>
                </div>
                <div class="hud-group">
                    <span class="hud-stat">üìú <span id="clue-count">0</span>/3</span>
                    <span class="hud-stat" id="key-indicator">üîë‚ùå</span>
                    <span class="timer" id="timer">00:00</span>
                    <button class="pause-btn" id="pause-btn">‚è∏Ô∏è</button>
                </div>
            </div>
            
            <div id="game-area">
                <div id="room"></div>
                <div id="fog"></div>
                <div class="player" id="player">üßë</div>
                <div class="grandpa" id="grandpa">üë¥</div>
                <div class="msg" id="msg"></div>
                <div class="minimap" id="minimap"></div>
                <div class="controls-hint">WASD: Hareket | E: Etkile≈üim | SHIFT: Ko≈ü</div>
            </div>
            
            <div id="mobile-controls">
                <div id="joystick-zone">
                    <div id="joystick-knob"></div>
                </div>
                <div class="mobile-btns">
                    <button class="mobile-btn" id="btn-action">üîç</button>
                    <button class="mobile-btn" id="btn-run">üèÉ</button>
                </div>
            </div>
        </div>
        
        <!-- MODALS -->
        <div class="modal" id="puzzle-modal">
            <div class="modal-box">
                <div class="modal-title">üß© BULMACA</div>
                <div class="modal-text" id="puz-text"></div>
                <input type="text" class="modal-input" id="puz-input" placeholder="?" autocomplete="off">
                <div class="feedback" id="puz-feedback"></div>
                <div class="hint" id="puz-hint"></div>
                <div class="modal-btns">
                    <button class="btn btn-teal" id="puz-submit">CEVAPLA</button>
                    <button class="btn btn-gray" id="puz-hint-btn">üí° ƒ∞PUCU</button>
                    <button class="btn btn-gray" id="puz-close">KAPAT</button>
                </div>
            </div>
        </div>
        
        <div class="modal" id="safe-modal">
            <div class="modal-box">
                <div class="modal-title">üîê Gƒ∞ZEMLƒ∞ KASA</div>
                <div class="safe-display" id="safe-display">_ _ _</div>
                <div class="clue-list" id="clue-list"></div>
                <input type="text" class="modal-input" id="safe-input" placeholder="3 haneli ≈üifre" maxlength="3" autocomplete="off">
                <div class="feedback" id="safe-feedback"></div>
                <div class="modal-btns">
                    <button class="btn btn-teal" id="safe-submit">≈ûƒ∞FREYƒ∞ Gƒ∞R</button>
                    <button class="btn btn-gray" id="safe-close">KAPAT</button>
                </div>
            </div>
        </div>
        
        <div class="modal hiding-modal" id="hide-modal">
            <div class="modal-box">
                <div class="hiding-text">ü§´ Saklanƒ±yorsun...</div>
                <div class="peephole" id="peephole">‚úì G√ºvende</div>
                <p style="color:#666;font-size:13px;margin-bottom:15px;">√áƒ±kmak i√ßin E veya butona bas</p>
                <button class="btn btn-purple" id="exit-hide-btn">üö™ √áIKI≈û</button>
                <div class="hide-warning" id="hide-warning">‚ö†Ô∏è Dede yakla≈üƒ±yor!</div>
            </div>
        </div>
        
        <div class="modal" id="pause-modal">
            <div class="modal-box">
                <div class="modal-title">‚è∏Ô∏è DURAKLATILDI</div>
                <div id="pause-stats" style="margin:15px 0;color:#888;"></div>
                <div class="modal-btns" style="flex-direction:column;gap:10px;">
                    <button class="btn btn-teal" id="resume-btn">‚ñ∂Ô∏è DEVAM</button>
                    <button class="btn btn-gray" id="restart-btn">üîÑ YENƒ∞DEN</button>
                    <button class="btn btn-purple" id="quit-btn">üè† MEN√ú</button>
                </div>
            </div>
        </div>
        
        <div class="modal" id="gameover-modal">
            <div class="modal-box">
                <h2 class="lose-title">üòÖ YAKALANDIN!</h2>
                <p class="modal-text">Dede seni yakaladƒ±!<br>Ama merak etme, tekrar deneyebilirsin.</p>
                <div id="lose-stats" style="margin:15px 0;color:#888;"></div>
                <div class="modal-btns">
                    <button class="btn btn-teal" id="retry-btn">üîÑ TEKRAR DENE</button>
                    <button class="btn btn-gray" id="menu-btn1">üè† MEN√ú</button>
                </div>
            </div>
        </div>
        
        <div class="modal" id="win-modal">
            <div class="modal-box">
                <h2 class="win-title">üéâ BA≈ûARDIN!</h2>
                <p class="modal-text" id="win-text"></p>
                <div id="win-stats" style="margin:15px 0;"></div>
                <div class="score" id="win-score"></div>
                <div class="modal-btns">
                    <button class="btn btn-teal" id="next-chapter-btn">SONRAKƒ∞ B√ñL√úM</button>
                    <button class="btn btn-gray" id="menu-btn2">üè† MEN√ú</button>
                </div>
            </div>
        </div>
        
        <div id="chapter-transition">
            <div class="chapter-title" id="trans-title"></div>
            <div class="chapter-subtitle" id="trans-subtitle"></div>
        </div>
    </div>

<script>
// ==================== VERƒ∞LER ====================
const CHARS = {
    mehmet: { name: 'MEHMET', emoji: 'üë¶', hp: 100, spd: 3.0, stealth: 0.5, desc: 'Dengeli' },
    gulten: { name: 'G√úLTEN', emoji: 'üëß', hp: 80, spd: 3.5, stealth: 0.7, desc: 'Hƒ±zlƒ±' },
    feyzullah: { name: 'FEYZULLAH', emoji: 'üßî', hp: 120, spd: 2.5, stealth: 0.4, desc: 'G√º√ßl√º' }
};

const CHAPTERS = [
    { 
        id: 1, 
        name: 'B√ñL√úM 1', 
        subtitle: 'Kolay Sorular',
        story: 'Dedenin evine ho≈ü geldin! Kolay sorularla ba≈ülƒ±yoruz...',
        grandpaSpeed: 0.8,
        damageMultiplier: 0.6
    },
    { 
        id: 2, 
        name: 'B√ñL√úM 2', 
        subtitle: 'Orta Seviye',
        story: 'Harika gidiyorsun! Sorular biraz zorla≈üƒ±yor...',
        grandpaSpeed: 1.0,
        damageMultiplier: 0.8
    },
    { 
        id: 3, 
        name: 'B√ñL√úM 3', 
        subtitle: 'Zor Sorular',
        story: 'Son b√∂l√ºm! En zor sorular seni bekliyor...',
        grandpaSpeed: 1.2,
        damageMultiplier: 1.0
    }
];

// Zorluk seviyelerine g√∂re bulmacalar (ƒ∞lkokul 2. Sƒ±nƒ±f)
const PUZZLES_EASY = [
    // === SAYILAR ===
    { q: '2 + 3 = ?', a: '5', h: 'Parmakla say!' },
    { q: '4 + 4 = ?', a: '8', h: '4 ve 4 topla' },
    { q: '5 + 2 = ?', a: '7', h: 'Bese iki ekle' },
    { q: '3 + 3 = ?', a: '6', h: 'Uc arti uc' },
    { q: '6 + 1 = ?', a: '7', h: 'Altiya bir ekle' },
    { q: '10 - 5 = ?', a: '5', h: 'Ondan bes cikar' },
    { q: '7 - 2 = ?', a: '5', h: 'Yediden iki cikar' },
    { q: '8 - 4 = ?', a: '4', h: 'Sekizden dort cikar' },
    { q: '2 x 2 = ?', a: '4', h: 'Iki kere iki' },
    { q: '3 x 2 = ?', a: '6', h: 'Uc kere iki' },
    
    // === GENEL KULTUR - KOLAY ===
    { q: 'Bir elde kac parmak var?', a: '5', h: 'Parmaklarini say' },
    { q: 'Gokyuzunun rengi nedir?', a: 'mavi', h: 'Yukari bak!' },
    { q: 'Cimenler hangi renktir?', a: 'yesil', h: 'Parklardaki renk' },
    { q: 'Gunesin rengi nedir?', a: 'sari', h: 'Parlak ve sicak' },
    { q: 'Bir haftada kac gun var?', a: '7', h: 'Pazartesiden Pazara' },
    { q: 'Karin rengi nedir?', a: 'beyaz', h: 'Kisin yagar' },
    { q: 'Domates hangi renktir?', a: 'kirmizi', h: 'Salatalarda bulunur' },
    { q: 'Muz hangi renktir?', a: 'sari', h: 'Maymunlarin sevdigi meyve' },
    { q: 'Kopek nasil ses cikarir?', a: 'hav', h: 'Hav hav!' },
    { q: 'Kedi nasil ses cikarir?', a: 'miyav', h: 'Miyav miyav!' },
    
    // === HAYVANLAR - KOLAY ===
    { q: 'Inek bize ne verir?', a: 'sut', h: 'Ictigimiz beyaz sivi' },
    { q: 'Tavuk bize ne verir?', a: 'yumurta', h: 'Kahvaltida yeriz' },
    { q: 'Bal yapan bocek hangisi?', a: 'ari', h: 'Vizz vizz sesi cikarir' },
    { q: 'Kuslar ne yapar?', a: 'ucar', h: 'Gokyuzunde hareket eder' },
    { q: 'Baliklar nerede yasar?', a: 'su', h: 'Deniz, gol, nehir...' },
];

const PUZZLES_MEDIUM = [
    // === SAYILAR ===
    { q: '5 + 7 = ?', a: '12', h: 'Parmaklari kullan' },
    { q: '9 + 6 = ?', a: '15', h: 'Dokuz arti alti' },
    { q: '15 - 8 = ?', a: '7', h: 'On besten sekiz cikar' },
    { q: '12 - 5 = ?', a: '7', h: 'On ikiden bes cikar' },
    { q: '4 x 3 = ?', a: '12', h: 'Dort kere uc' },
    { q: '5 x 2 = ?', a: '10', h: 'Bes kere iki' },
    { q: '3 x 4 = ?', a: '12', h: 'Uc kere dort' },
    { q: '2, 4, 6, 8, ? (Sonraki)', a: '10', h: 'Ikiser sayiyoruz' },
    { q: '5, 10, 15, ? (Sonraki)', a: '20', h: 'Beser atliyoruz' },
    { q: '10, 20, 30, ? (Sonraki)', a: '40', h: 'Onar atliyoruz' },
    
    // === GENEL KULTUR - ORTA ===
    { q: 'Bir yilda kac ay var?', a: '12', h: 'Ocak, Subat, Mart...' },
    { q: 'Bir yilda kac mevsim var?', a: '4', h: 'Ilkbahar, yaz, sonbahar, kis' },
    { q: 'Turk bayraginin renkleri?', a: 'kirmizi beyaz', h: 'Ay yildizli bayrak' },
    { q: 'Gunes hangi yonden dogar?', a: 'dogu', h: 'Sabahleyin oradan gelir' },
    { q: 'Gunes hangi yonde batar?', a: 'bati', h: 'Aksamleyin oraya gider' },
    { q: 'Kuzeyin karsisi hangi yon?', a: 'guney', h: 'Haritada asagisi' },
    { q: 'Bir gunde kac saat var?', a: '24', h: 'Gece ve gunduz toplam' },
    { q: 'Ucgenin kac kosesi var?', a: '3', h: 'Adinda ipucu var' },
    { q: 'Karenin kac kenari var?', a: '4', h: 'Hepsi esit uzunlukta' },
    { q: 'Dairenin kac kosesi var?', a: '0', h: 'Yuvarlaktir' },
    
    // === HAYVANLAR - ORTA ===
    { q: 'En buyuk kara hayvani?', a: 'fil', h: 'Uzun hortumu var' },
    { q: 'En hizli kara hayvani?', a: 'cita', h: 'Benekli kedi turu' },
    { q: 'Penguen ne yer?', a: 'balik', h: 'Denizde avlar' },
    { q: 'Kanguru hangi ulkede yasar?', a: 'avustralya', h: 'Cok uzak bir ulke' },
    { q: 'Zurafa neyle unludur?', a: 'boyun', h: 'Cok uzun!' },
];

const PUZZLES_HARD = [
    // === SAYILAR ===
    { q: '18 + 15 = ?', a: '33', h: 'Yavas yavas topla' },
    { q: '25 + 17 = ?', a: '42', h: 'Onlari ayir, birler ekle' },
    { q: '30 - 12 = ?', a: '18', h: 'Otuzdan on iki cikar' },
    { q: '50 - 25 = ?', a: '25', h: 'Yarisini bul' },
    { q: '6 x 4 = ?', a: '24', h: 'Alti kere dort' },
    { q: '7 x 3 = ?', a: '21', h: 'Yedi kere uc' },
    { q: '8 x 5 = ?', a: '40', h: 'Sekiz kere bes' },
    { q: '1, 1, 2, 3, 5, ? (Sonraki)', a: '8', h: 'Onceki ikisini topla' },
    { q: '1, 4, 9, 16, ? (Sonraki)', a: '25', h: '1x1, 2x2, 3x3, 4x4...' },
    { q: '100 - 45 = ?', a: '55', h: 'Yuzden cikar' },
    
    // === GENEL KULTUR - ZOR ===
    { q: 'Turkiyenin baskenti neresi?', a: 'ankara', h: 'Baskent, en buyuk sehir degil' },
    { q: 'Dunyanin uydusu nedir?', a: 'ay', h: 'Geceleri parliyor' },
    { q: 'Suyun kaynama derecesi?', a: '100', h: 'Derece cinsinden' },
    { q: 'Suyun donma derecesi?', a: '0', h: 'Buz olur' },
    { q: 'Gokkusaginda kac renk var?', a: '7', h: 'Kirmizidan mora' },
    { q: 'En buyuk gezegen hangisi?', a: 'jupiter', h: 'Gunes sisteminde' },
    { q: 'Bir asirda kac yil var?', a: '100', h: 'Yuzyil demek' },
    { q: 'Bir duzinede kac tane var?', a: '12', h: 'Yumurta kolisi gibi' },
    { q: 'Kalp vucudun neresinde?', a: 'gogus', h: 'Sol tarafta atar' },
    { q: 'Dunyanin sekli nasil?', a: 'yuvarlak', h: 'Top gibi' },
    
    // === BILMECELER - ZOR ===
    { q: 'Ayagi var yurumez, ne?', a: 'masa', h: 'Ustune yemek koyarsin' },
    { q: 'Dili var konusmaz, ne?', a: 'terazi', h: 'Agirlik olcer' },
    { q: 'Gozu var gormez, ne?', a: 'igne', h: 'Dikiste kullanilir' },
    { q: 'Yesil cikar kirmizi biter?', a: 'domates', h: 'Sebze ya da meyve' },
    { q: 'Kanadi var ucamaz?', a: 'penguen', h: 'Kutuplarda yasar' },
];

// T√ºm bulmacalarƒ± birle≈ütir (zorluk se√ßimi i√ßin)
const PUZZLE_POOLS = {
    1: PUZZLES_EASY,
    2: PUZZLES_MEDIUM,
    3: PUZZLES_HARD
};

const ROOMS = {
    salon: {
        name: 'SALON', bg: 'room-salon',
        furniture: [
            { x: 20, y: 150, w: 110, h: 50, icon: 'üõãÔ∏è', c: '#6b5344', type: 'kanepe' },
            { x: 20, y: 230, w: 60, h: 50, icon: 'ü™ë', c: '#5a4535', type: 'koltuk' },
            { x: 150, y: 100, w: 80, h: 50, icon: 'üì∫', c: '#2a2a3a', type: 'tv' },
            { x: 700, y: 150, w: 70, h: 100, icon: 'üóÑÔ∏è', c: '#4a3a2a', hide: true, type: 'dolap' },
            { x: 150, y: 420, w: 90, h: 40, icon: 'ü™¥', c: '#3a4a3a', type: 'saksƒ±' }
        ],
        puzzleSpots: [
            { x: 350, y: 100, icon: 'üñºÔ∏è' },
            { x: 500, y: 100, icon: 'üìö' }
        ],
        clueSpot: { x: 600, y: 420, icon: 'üìú' },
        doors: [
            { x: 770, y: 300, w: 30, h: 80, to: 'mutfak', dir: 'right' },
            { x: 400, y: 60, w: 80, h: 30, to: 'yatak', dir: 'top' }
        ],
        patrol: [{x:200,y:350},{x:500,y:400},{x:650,y:350},{x:400,y:380}]
    },
    mutfak: {
        name: 'MUTFAK', bg: 'room-mutfak',
        furniture: [
            { x: 20, y: 100, w: 60, h: 100, icon: 'üßä', c: '#8a9a9a', type: 'buzdolabƒ±' },
            { x: 20, y: 230, w: 100, h: 45, icon: 'üç≥', c: '#7a6a5a', type: 'tezgah' },
            { x: 140, y: 230, w: 60, h: 45, icon: 'üö∞', c: '#6a7a8a', type: 'lavabo' },
            { x: 150, y: 420, w: 80, h: 40, icon: 'ü™ë', c: '#5a4a3a', type: 'masa' },
            { x: 680, y: 380, w: 80, h: 70, icon: 'üì¶', c: '#5a4a3a', hide: true, type: 'kutu' }
        ],
        puzzleSpots: [
            { x: 500, y: 100, icon: 'üìñ' }
        ],
        clueSpot: { x: 350, y: 420, icon: 'üìú' },
        doors: [
            { x: 0, y: 300, w: 30, h: 80, to: 'salon', dir: 'left' },
            { x: 400, y: 60, w: 80, h: 30, to: 'bodrum', dir: 'top' }
        ],
        patrol: [{x:300,y:350},{x:550,y:400},{x:650,y:300},{x:400,y:350}]
    },
    yatak: {
        name: 'YATAK ODASI', bg: 'room-yatak',
        furniture: [
            { x: 20, y: 120, w: 130, h: 70, icon: 'üõèÔ∏è', c: '#5a4a4a', hide: true, type: 'yatak' },
            { x: 20, y: 220, w: 60, h: 100, icon: 'üö™', c: '#4a3a2a', hide: true, type: 'gardrop' },
            { x: 680, y: 100, w: 60, h: 50, icon: 'ü™û', c: '#6a7a8a', type: 'ayna' },
            { x: 680, y: 200, w: 80, h: 50, icon: 'üíª', c: '#3a3a4a', type: 'masa' },
            { x: 200, y: 420, w: 50, h: 40, icon: 'üß∏', c: '#8a6a5a', type: 'oyuncak' }
        ],
        puzzleSpots: [
            { x: 400, y: 100, icon: 'üñºÔ∏è' }
        ],
        clueSpot: { x: 550, y: 420, icon: 'üìú' },
        safeSpot: { x: 680, y: 420 },
        doors: [
            { x: 400, y: 480, w: 80, h: 30, to: 'salon', dir: 'bottom' },
            { x: 770, y: 300, w: 30, h: 80, to: 'bodrum', dir: 'right' }
        ],
        patrol: [{x:250,y:350},{x:500,y:420},{x:650,y:350},{x:400,y:380}]
    },
    bodrum: {
        name: 'BODRUM', bg: 'room-bodrum',
        furniture: [
            { x: 20, y: 120, w: 50, h: 50, icon: 'üì¶', c: '#4a3a2a', type: 'kutu1' },
            { x: 20, y: 200, w: 50, h: 50, icon: 'üì¶', c: '#3a2a1a', type: 'kutu2' },
            { x: 20, y: 400, w: 60, h: 50, icon: 'üõ†Ô∏è', c: '#5a5a5a', type: 'alet' },
            { x: 650, y: 350, w: 90, h: 80, icon: 'üì¶', c: '#5a4a3a', hide: true, type: 'kutu3' },
            { x: 650, y: 200, w: 50, h: 55, icon: 'üõ¢Ô∏è', c: '#5a4a3a', type: 'varil' },
            { x: 300, y: 120, w: 55, h: 45, icon: 'üïØÔ∏è', c: '#4a4a4a', type: 'raf' }
        ],
        puzzleSpots: [],
        clueSpot: null,
        doors: [
            { x: 400, y: 480, w: 80, h: 30, to: 'mutfak', dir: 'bottom' },
            { x: 0, y: 300, w: 30, h: 80, to: 'yatak', dir: 'left' },
            { x: 720, y: 90, w: 60, h: 50, to: 'exit', dir: 'right', isExit: true }
        ],
        patrol: [{x:200,y:350},{x:450,y:400},{x:550,y:350},{x:350,y:380}]
    }
};

// Giri≈ü pozisyonlarƒ± - t√ºm odalarda ortada, mobilyalardan uzak
const ENTRY = { 
    left: {x: 100, y: 340},   // Soldan girince
    right: {x: 680, y: 340},  // Saƒüdan girince  
    top: {x: 440, y: 200},    // √ústten girince
    bottom: {x: 440, y: 380}  // Alttan girince
};

// ==================== OYUN DURUMU ====================
let G = {
    running: false,
    paused: false,
    chapter: 1,
    room: 'salon',
    char: null,
    hp: 100,
    maxHp: 100,
    energy: 100,
    cluesFound: 0,
    clueAnswers: [],
    hasKey: false,
    hiding: false,
    hideSpot: null,
    invincible: false,
    px: 400, py: 320,
    gx: 100, gy: 300,
    gRoom: 'mutfak',
    gChasing: false,
    gPatrolIdx: 0,
    gRoomDelay: 200,
    startTime: 0,
    currentPuzzle: null,
    roomPuzzles: {},
    roomClues: {},
    safeCode: '',
    completedChapters: [false, false, false]
};

let keys = { w:false, a:false, s:false, d:false, shift:false };
let joystick = { active: false, dx: 0, dy: 0 };
let mobileRun = false;
let msgTimeout = null;
let timerInterval = null;

// ==================== YARDIMCI ====================
const $ = id => document.getElementById(id);

// Haptic feedback for mobile
function vibrate(pattern = 50) {
    if ("vibrate" in navigator) {
        navigator.vibrate(pattern);
    }
}
const dist = (x1,y1,x2,y2) => Math.sqrt((x2-x1)**2 + (y2-y1)**2);
const clamp = (v,min,max) => Math.max(min, Math.min(max, v));
const collides = (a,b) => a.x < b.x+b.w && a.x+a.w > b.x && a.y < b.y+b.h && a.y+a.h > b.y;
const rand = (min,max) => Math.floor(Math.random()*(max-min+1))+min;
const shuffle = arr => [...arr].sort(() => Math.random() - 0.5);
const isMobile = () => window.innerWidth <= 600 || 'ontouchstart' in window;

function showMsg(text, dur=2500) {
    const el = $('msg');
    el.innerHTML = text;
    el.classList.add('show');
    clearTimeout(msgTimeout);
    msgTimeout = setTimeout(() => el.classList.remove('show'), dur);
}

function formatTime(s) {
    return Math.floor(s/60).toString().padStart(2,'0') + ':' + (s%60).toString().padStart(2,'0');
}

// ==================== BULMACA OLU≈ûTUR ====================
function generatePuzzles() {
    // B√∂l√ºme g√∂re zorluk havuzunu se√ß
    const puzzlePool = PUZZLE_POOLS[G.chapter] || PUZZLES_EASY;
    
    // Her oyunda tamamen rastgele 3 bulmaca se√ß
    const shuffled = shuffle([...puzzlePool]);
    const selected = shuffled.slice(0, 3);
    
    // 3 haneli rastgele ≈üifre olu≈ütur (her oyunda farklƒ±)
    const code = [
        Math.floor(Math.random() * 9) + 1,  // 1-9
        Math.floor(Math.random() * 10),      // 0-9
        Math.floor(Math.random() * 10)       // 0-9
    ];
    G.safeCode = code.join('');
    
    G.roomPuzzles = {};
    G.roomClues = {};
    G.clueAnswers = [];
    
    // Her odaya bir bulmaca ve ipucu ata
    G.roomPuzzles['salon'] = [{ ...selected[0], digit: code[0], digitPos: 1, solved: false }];
    G.roomClues['salon'] = { found: false, digit: code[0], pos: 1 };
    
    G.roomPuzzles['mutfak'] = [{ ...selected[1], digit: code[1], digitPos: 2, solved: false }];
    G.roomClues['mutfak'] = { found: false, digit: code[1], pos: 2 };
    
    G.roomPuzzles['yatak'] = [{ ...selected[2], digit: code[2], digitPos: 3, solved: false }];
    G.roomClues['yatak'] = { found: false, digit: code[2], pos: 3 };
    
    const diffNames = {1: 'Kolay', 2: 'Orta', 3: 'Zor'};
    console.log(`B√∂l√ºm ${G.chapter} (${diffNames[G.chapter]}) - Kasa ≈üifresi:`, G.safeCode);
    console.log('Bulmaca 1:', selected[0].q);
    console.log('Bulmaca 2:', selected[1].q);
    console.log('Bulmaca 3:', selected[2].q);
}

// ==================== MEN√ú ====================
function initMenu() {
    const grid = $('char-grid');
    grid.innerHTML = '';
    for (const id in CHARS) {
        const c = CHARS[id];
        const card = document.createElement('div');
        card.className = 'char-card';
        card.dataset.id = id;
        card.innerHTML = `
            <div class="char-sprite">${c.emoji}</div>
            <div class="char-name">${c.name}</div>
            <div class="char-stats">‚ù§Ô∏è${c.hp} ‚ö°${c.spd.toFixed(1)}</div>
        `;
        card.onclick = () => selectChar(id);
        grid.appendChild(card);
    }
    
    const chapterDiv = $('chapter-select');
    chapterDiv.innerHTML = '';
    CHAPTERS.forEach((ch, i) => {
        const btn = document.createElement('button');
        btn.className = 'chapter-btn' + (i === 0 ? ' selected' : '');
        btn.textContent = `${ch.id}. B√ñL√úM`;
        btn.disabled = i > 0 && !G.completedChapters[i-1];
        btn.onclick = () => selectChapter(ch.id);
        chapterDiv.appendChild(btn);
    });
    
    loadProgress();
}

function selectChar(id) {
    vibrate(30);
    document.querySelectorAll('.char-card').forEach(c => c.classList.remove('selected'));
    document.querySelector(`[data-id="${id}"]`).classList.add('selected');
    G.char = id;
    $('start-btn').disabled = false;
}

function selectChapter(id) {
    G.chapter = id;
    document.querySelectorAll('.chapter-btn').forEach((b,i) => b.classList.toggle('selected', i === id-1));
}

function loadProgress() {
    try {
        const saved = JSON.parse(localStorage.getItem('dedeEviProgress'));
        if (saved) {
            G.completedChapters = saved.chapters || [false, false, false];
            document.querySelectorAll('.chapter-btn').forEach((btn, i) => {
                btn.disabled = i > 0 && !G.completedChapters[i-1];
            });
            if (saved.highscore) $('highscore').textContent = `üèÜ En ƒ∞yi: ${saved.highscore} puan`;
        }
    } catch(e) {}
}

function saveProgress() {
    try {
        const saved = JSON.parse(localStorage.getItem('dedeEviProgress')) || {};
        saved.chapters = G.completedChapters;
        localStorage.setItem('dedeEviProgress', JSON.stringify(saved));
    } catch(e) {}
}

// ==================== OYUN BA≈ûLAT ====================
function startGame() {
    vibrate(50);
    if (!G.char) return;
    
    const ch = CHAPTERS[G.chapter - 1];
    const c = CHARS[G.char];
    
    G.maxHp = c.hp;
    G.hp = c.hp;
    G.energy = 100;
    G.running = true;
    G.paused = false;
    G.room = 'salon';
    G.px = 400; G.py = 300; // Ba≈ülangƒ±√ß pozisyonu
    G.gx = 100; G.gy = 300;
    G.gRoom = 'mutfak';
    G.gChasing = false;
    G.gPatrolIdx = 0;
    G.gRoomDelay = 200;
    G.cluesFound = 0;
    G.clueAnswers = [];
    G.hasKey = false;
    G.hiding = false;
    G.hideSpot = null;
    G.invincible = false;
    G.startTime = Date.now();
    G.currentPuzzle = null;
    
    generatePuzzles();
    
    $('menu').classList.remove('active');
    $('game').classList.add('active');
    $('player').textContent = c.emoji;
    $('chapter-ind').textContent = `B√ñL√úM ${G.chapter}`;
    
    renderRoom();
    updateHUD();
    
    // Sƒ±kƒ±≈üma kontrol√º
    setTimeout(() => checkAndFixPosition(), 100);
    
    showChapterTransition(ch, () => {
        timerInterval = setInterval(updateTimer, 1000);
        requestAnimationFrame(gameLoop);
    });
}

function showChapterTransition(chapter, callback) {
    $('trans-title').textContent = chapter.name;
    $('trans-subtitle').textContent = chapter.story;
    $('chapter-transition').classList.add('active');
    
    setTimeout(() => {
        $('chapter-transition').classList.remove('active');
        showMsg('üîç Bulmacalarƒ± √ß√∂z, kasayƒ± a√ß, ka√ß!', 3000);
        callback();
    }, 2500);
}

// ==================== ODA RENDER ====================
function renderRoom() {
    const room = ROOMS[G.room];
    const el = $('room');
    el.innerHTML = '';
    el.className = room.bg;
    
    // Zemin
    const floor = document.createElement('div');
    floor.className = 'room-floor';
    el.appendChild(floor);
    
    // Duvar dekorasyonu (arka plan)
    const wallDecor = document.createElement('div');
    wallDecor.className = 'room-wall-decor';
    wallDecor.textContent = G.room === 'salon' ? 'üñºÔ∏è' : G.room === 'mutfak' ? 'üçΩÔ∏è' : G.room === 'yatak' ? 'üåô' : 'üïØÔ∏è';
    wallDecor.style.cssText = 'position:absolute;top:60px;left:50%;transform:translateX(-50%);font-size:50px;opacity:0.08;';
    el.appendChild(wallDecor);
    
    // Mobilyalar
    room.furniture.forEach(f => {
        const div = document.createElement('div');
        div.className = 'furniture' + (f.hide ? ' hideable' : '');
        
        // Mobilya tipine g√∂re farklƒ± stiller
        let extraStyle = '';
        if (f.icon === 'üßä') extraStyle = 'border-radius: 4px 4px 0 0;'; // Buzdolabƒ±
        if (f.icon === 'üõãÔ∏è') extraStyle = 'border-radius: 8px 8px 4px 4px;'; // Kanepe
        if (f.icon === 'üõèÔ∏è') extraStyle = 'border-radius: 6px;'; // Yatak
        if (f.icon === 'üì¶') extraStyle = 'border-radius: 2px;'; // Kutu
        
        div.style.cssText = `left:${f.x}px;top:${f.y}px;width:${f.w}px;height:${f.h}px;background:${f.c};${extraStyle}`;
        div.innerHTML = `<span style="filter:drop-shadow(1px 1px 1px rgba(0,0,0,0.3))">${f.icon}</span>`;
        el.appendChild(div);
    });
    
    // Bulmacalar
    if (G.roomPuzzles[G.room]) {
        const spots = room.puzzleSpots;
        G.roomPuzzles[G.room].forEach((p, i) => {
            if (p.solved) return;
            const spot = spots[i] || spots[0];
            const div = document.createElement('div');
            div.className = 'puzzle-obj';
            div.style.cssText = `left:${spot.x}px;top:${spot.y}px;`;
            div.textContent = spot.icon;
            el.appendChild(div);
        });
    }
    
    // ƒ∞pucu objesi
    if (room.clueSpot && G.roomClues[G.room] && !G.roomClues[G.room].found) {
        const div = document.createElement('div');
        div.className = 'clue-obj';
        div.style.cssText = `left:${room.clueSpot.x}px;top:${room.clueSpot.y}px;`;
        div.textContent = room.clueSpot.icon;
        el.appendChild(div);
    }
    
    // Kasa (yatak odasƒ±)
    if (G.room === 'yatak' && !G.hasKey) {
        const spot = room.safeSpot;
        const div = document.createElement('div');
        div.className = 'puzzle-obj';
        div.style.cssText = `left:${spot.x}px;top:${spot.y}px;font-size:32px;`;
        div.textContent = 'üîê';
        el.appendChild(div);
    }
    
    // Kapƒ±lar
    room.doors.forEach(d => {
        const div = document.createElement('div');
        let cls = 'door';
        if (d.isExit) cls += ' exit' + (!G.hasKey ? ' locked' : '');
        div.className = cls;
        div.style.cssText = `left:${d.x}px;top:${d.y}px;width:${d.w}px;height:${d.h}px;`;
        const arrows = {left:'‚óÄ',right:'‚ñ∂',top:'‚ñ≤',bottom:'‚ñº'};
        if (!d.isExit) {
            div.innerHTML = `<span style="font-size:18px">${arrows[d.dir]}</span><span class="door-label">${ROOMS[d.to]?.name.substring(0,3)||''}</span>`;
        }
        el.appendChild(div);
    });
    
    $('room-name').textContent = room.name;
    updateMinimap();
}

// ==================== HUD ====================
function updateHUD() {
    $('health-bar').style.width = (G.hp / G.maxHp * 100) + '%';
    $('energy-bar').style.width = G.energy + '%';
    $('clue-count').textContent = G.cluesFound;
    $('key-indicator').textContent = G.hasKey ? 'üîë‚úì' : 'üîë‚ùå';
}

function updateTimer() {
    if (!G.running || G.paused) return;
    const s = Math.floor((Date.now() - G.startTime) / 1000);
    $('timer').textContent = formatTime(s);
}

function updateMinimap() {
    const map = $('minimap');
    map.innerHTML = '';
    const layout = [{id:'yatak',name:'YTK'},{id:'bodrum',name:'BOD'},{id:'salon',name:'SAL'},{id:'mutfak',name:'MUT'}];
    layout.forEach(r => {
        const div = document.createElement('div');
        div.className = 'map-room' + (r.id===G.room?' current':'') + (r.id===G.gRoom?' has-grandpa':'');
        div.textContent = r.name;
        map.appendChild(div);
    });
}

// ==================== OYUN D√ñNG√úS√ú ====================
function gameLoop() {
    if (!G.running) return;
    
    const safeModal = $('safe-modal');
    const safeActive = safeModal && safeModal.classList.contains('active');
    
    if (!G.paused && !G.hiding && !G.currentPuzzle && !safeActive) {
        movePlayer();
        moveGrandpa();
        checkCollision();
    }
    
    if (G.hiding) updateHidingView();
    
    $('player').style.left = G.px + 'px';
    $('player').style.top = G.py + 'px';
    $('grandpa').style.left = G.gx + 'px';
    $('grandpa').style.top = G.gy + 'px';
    $('grandpa').classList.toggle('visible', G.gRoom === G.room);
    $('grandpa').classList.toggle('chasing', G.gChasing);
    $('grandpa').textContent = G.gChasing ? 'üßì' : 'üë¥';
    
    requestAnimationFrame(gameLoop);
}

let debugCounter = 0;
function movePlayer() {
    const c = CHARS[G.char];
    if (!c) { console.log('No character!'); return; }
    
    const running = (keys.shift || mobileRun) && G.energy > 10;
    let spd = c.spd * (running ? 1.8 : 1);
    
    let dx = 0, dy = 0;
    
    if (joystick.active) {
        dx = joystick.dx * spd;
        dy = joystick.dy * spd;
    } else {
        if (keys.w) dy -= spd;
        if (keys.s) dy += spd;
        if (keys.a) dx -= spd;
        if (keys.d) dx += spd;
        if (dx && dy) { dx *= 0.707; dy *= 0.707; }
    }
    
    if (dx === 0 && dy === 0) {
        G.energy = Math.min(100, G.energy + 0.2);
        updateHUD();
        return;
    }
    
    if (running) G.energy = Math.max(0, G.energy - 0.4);
    else G.energy = Math.min(100, G.energy + 0.1);
    
    // Dinamik ekran boyutlarƒ±
    const gameArea = $('game-area');
    const maxX = gameArea ? gameArea.clientWidth - 35 : 760;
    const maxY = gameArea ? gameArea.clientHeight - 50 : 440;
    
    const newX = G.px + dx;
    const newY = G.py + dy;
    
    const room = ROOMS[G.room];
    let canX = true, canY = true;
    
    // Mobilya √ßarpƒ±≈üma kontrol√º
    for (const f of room.furniture) {
        if (collides({x:newX,y:G.py,w:28,h:40}, {x:f.x,y:f.y,w:f.w,h:f.h})) canX = false;
        if (collides({x:G.px,y:newY,w:28,h:40}, {x:f.x,y:f.y,w:f.w,h:f.h})) canY = false;
    }
    
    if (canX) G.px = clamp(newX, 10, maxX);
    if (canY) G.py = clamp(newY, 60, maxY);
    
    updateHUD();
}

// Karakter sƒ±kƒ±≈üma kontrol√º - odaya girerken
function checkAndFixPosition() {
    const room = ROOMS[G.room];
    const gameArea = $('game-area');
    const maxX = gameArea ? gameArea.clientWidth - 35 : 760;
    const maxY = gameArea ? gameArea.clientHeight - 50 : 440;
    
    // Mevcut pozisyonda sƒ±kƒ±≈üƒ±k mƒ± kontrol et
    let stuck = false;
    for (const f of room.furniture) {
        if (collides({x:G.px,y:G.py,w:28,h:40}, {x:f.x,y:f.y,w:f.w,h:f.h})) {
            stuck = true;
            break;
        }
    }
    
    // Sƒ±kƒ±≈üƒ±ksa g√ºvenli pozisyon bul
    if (stuck) {
        console.log('Karakter sƒ±kƒ±≈ütƒ±, pozisyon d√ºzeltiliyor...');
        // Odanƒ±n ortasƒ±na doƒüru g√ºvenli yer ara
        const centerX = maxX / 2;
        const centerY = maxY / 2;
        
        for (let radius = 50; radius < 300; radius += 30) {
            for (let angle = 0; angle < 360; angle += 30) {
                const testX = centerX + Math.cos(angle * Math.PI / 180) * radius;
                const testY = centerY + Math.sin(angle * Math.PI / 180) * radius;
                
                let safe = true;
                for (const f of room.furniture) {
                    if (collides({x:testX,y:testY,w:28,h:40}, {x:f.x,y:f.y,w:f.w,h:f.h})) {
                        safe = false;
                        break;
                    }
                }
                
                if (safe && testX > 10 && testX < maxX && testY > 60 && testY < maxY) {
                    G.px = testX;
                    G.py = testY;
                    console.log('G√ºvenli pozisyon bulundu:', testX, testY);
                    return;
                }
            }
        }
        
        // Hi√ßbir yer bulunamazsa merkeze zorla
        G.px = centerX;
        G.py = centerY;
    }
}

function moveGrandpa() {
    const ch = CHAPTERS[G.chapter - 1];
    
    if (G.gRoom === G.room && !G.hiding) {
        G.gChasing = true;
        const spd = 1.3 * ch.grandpaSpeed;
        const dx = G.px - G.gx;
        const dy = G.py - G.gy;
        const dst = Math.sqrt(dx*dx + dy*dy);
        if (dst > 5) {
            G.gx += (dx/dst) * spd;
            G.gy += (dy/dst) * spd;
        }
    } else {
        G.gChasing = false;
        const room = ROOMS[G.gRoom];
        const target = room.patrol[G.gPatrolIdx];
        const dx = target.x - G.gx;
        const dy = target.y - G.gy;
        const dst = Math.sqrt(dx*dx + dy*dy);
        const spd = 0.9 * ch.grandpaSpeed;
        if (dst > 5) {
            G.gx += (dx/dst) * spd;
            G.gy += (dy/dst) * spd;
        } else {
            G.gPatrolIdx = (G.gPatrolIdx + 1) % room.patrol.length;
        }
        
        G.gRoomDelay--;
        if (G.gRoomDelay <= 0) {
            if (Math.random() < 0.3) {
                const doors = room.doors.filter(d => !d.isExit);
                if (doors.length) {
                    const door = doors[rand(0, doors.length-1)];
                    G.gRoom = door.to;
                    G.gPatrolIdx = 0;
                    const r = ROOMS[G.gRoom];
                    if (r.patrol.length) { G.gx = r.patrol[0].x; G.gy = r.patrol[0].y; }
                    if (G.gRoom === G.room) showMsg('üëÄ Dede odana geldi!', 2000);
                }
            }
            G.gRoomDelay = 180 + rand(0, 100);
        }
    }
    
    const gameArea = $('game-area');
    const maxX = gameArea ? gameArea.clientWidth - 40 : 760;
    const maxY = gameArea ? gameArea.clientHeight - 60 : 440;
    
    G.gx = clamp(G.gx, 10, maxX);
    G.gy = clamp(G.gy, 60, maxY);
    updateMinimap();
}

function checkCollision() {
    if (G.gRoom !== G.room || G.invincible) return;
    
    const d = dist(G.px+14, G.py+21, G.gx+18, G.gy+25);
    if (d < 35) {
        takeDamage(15 * CHAPTERS[G.chapter-1].damageMultiplier);
    }
}

function takeDamage(amt) {
    G.hp -= amt;
    updateHUD();
    
    $('game-area').classList.add('shake');
    $('player').classList.add('hurt');
    setTimeout(() => {
        $('game-area').classList.remove('shake');
        $('player').classList.remove('hurt');
    }, 400);
    
    G.invincible = true;
    setTimeout(() => G.invincible = false, 1500);
    
    if (G.hp <= 0) gameOver();
}

// ==================== ETKƒ∞LE≈ûƒ∞M ====================
function interact() {
    if (G.hiding) { exitHide(); return; }
    if (G.currentPuzzle || G.paused) return;
    if ($('safe-modal').classList.contains('active')) return;
    
    const room = ROOMS[G.room];
    const px = G.px + 14, py = G.py + 21;
    
    for (const d of room.doors) {
        if (dist(px, py, d.x + d.w/2, d.y + d.h/2) < 55) {
            useDoor(d);
            return;
        }
    }
    
    if (G.room === 'yatak' && !G.hasKey) {
        const safe = room.safeSpot;
        if (dist(px, py, safe.x + 16, safe.y + 16) < 55) {
            openSafe();
            return;
        }
    }
    
    if (room.clueSpot && G.roomClues[G.room] && !G.roomClues[G.room].found) {
        if (dist(px, py, room.clueSpot.x + 12, room.clueSpot.y + 12) < 55) {
            collectClue();
            return;
        }
    }
    
    if (G.roomPuzzles[G.room]) {
        const spots = room.puzzleSpots;
        for (let i = 0; i < G.roomPuzzles[G.room].length; i++) {
            const p = G.roomPuzzles[G.room][i];
            if (p.solved) continue;
            const spot = spots[i] || spots[0];
            if (dist(px, py, spot.x + 14, spot.y + 14) < 55) {
                openPuzzle(G.room, i);
                return;
            }
        }
    }
    
    for (const f of room.furniture) {
        if (f.hide && dist(px, py, f.x + f.w/2, f.y + f.h/2) < 70) {
            tryHide(f);
            return;
        }
    }
    
    showMsg('Yakƒ±nda bir ≈üey yok...', 1000);
}

function useDoor(door) {
    if (door.isExit) {
        if (G.hasKey) {
            chapterWin();
        } else {
            showMsg('üîí Kapƒ± kilitli! Kasadan anahtarƒ± al.', 2500);
        }
        return;
    }
    
    G.room = door.to;
    const opp = {left:'right',right:'left',top:'bottom',bottom:'top'};
    const entry = ENTRY[opp[door.dir]];
    G.px = entry.x; G.py = entry.y;
    renderRoom();
    
    // Sƒ±kƒ±≈üma kontrol√º
    setTimeout(() => checkAndFixPosition(), 50);
    
    showMsg('üìç ' + ROOMS[G.room].name, 1200);
}

function collectClue() {
    const clue = G.roomClues[G.room];
    clue.found = true;
    G.cluesFound++;
    G.clueAnswers.push({ pos: clue.pos, digit: clue.digit });
    
    updateHUD();
    renderRoom();
    showMsg(`üìú ƒ∞pucu! ≈ûifrenin ${clue.pos}. rakamƒ±: <b style="color:var(--gold)">${clue.digit}</b>`, 3500);
}

function openPuzzle(roomId, idx) {
    const p = G.roomPuzzles[roomId][idx];
    G.currentPuzzle = { roomId, idx, puzzle: p };
    
    $('puz-text').innerHTML = p.q;
    $('puz-input').value = '';
    $('puz-feedback').textContent = '';
    $('puz-hint').textContent = '';
    $('puzzle-modal').classList.add('active');
    setTimeout(() => $('puz-input').focus(), 100);
}

function submitPuzzle() {
    if (!G.currentPuzzle) return;
    const p = G.currentPuzzle.puzzle;
    
    // T√ºrk√ße karakterleri ve b√ºy√ºk/k√º√ß√ºk harfleri normalize et
    const normalize = (str) => {
        return str.toString().trim()
            .toLowerCase()
            .replace(/≈ü/gi, 's').replace(/≈û/gi, 's')
            .replace(/ƒü/gi, 'g').replace(/ƒû/gi, 'g')
            .replace(/√º/gi, 'u').replace(/√ú/gi, 'u')
            .replace(/√∂/gi, 'o').replace(/√ñ/gi, 'o')
            .replace(/√ß/gi, 'c').replace(/√á/gi, 'c')
            .replace(/ƒ±/gi, 'i').replace(/ƒ∞/gi, 'i')
            .replace(/I/gi, 'i')
            .replace(/\s+/g, ' '); // Birden fazla bo≈üluƒüu teke indir
    };
    
    const userAnswer = normalize($('puz-input').value);
    const correctAnswer = normalize(p.a);
    
    if (userAnswer === correctAnswer) {
        $('puz-feedback').className = 'feedback correct';
        $('puz-feedback').textContent = '‚úì DOƒûRU!';
        p.solved = true;
        
        showMsg(`‚ú® ≈ûifrenin ${p.digitPos}. rakamƒ±: <b style="color:var(--gold)">${p.digit}</b>`, 3500);
        G.clueAnswers.push({ pos: p.digitPos, digit: p.digit });
        G.cluesFound++;
        updateHUD();
        
        setTimeout(() => {
            $('puzzle-modal').classList.remove('active');
            G.currentPuzzle = null;
            renderRoom();
        }, 1200);
    } else {
        $('puz-feedback').className = 'feedback wrong';
        $('puz-feedback').textContent = '‚úó Yanlƒ±≈ü, tekrar dene!';
        $('puz-input').value = '';
        $('puz-input').focus();
    }
}

function showPuzzleHint() {
    if (G.currentPuzzle) $('puz-hint').textContent = 'üí° ' + G.currentPuzzle.puzzle.h;
}

function closePuzzle() {
    $('puzzle-modal').classList.remove('active');
    G.currentPuzzle = null;
}

// ==================== KASA ====================
function openSafe() {
    $('safe-modal').classList.add('active');
    updateSafeDisplay();
    $('safe-input').value = '';
    $('safe-feedback').textContent = '';
    setTimeout(() => $('safe-input').focus(), 100);
}

function updateSafeDisplay() {
    const list = $('clue-list');
    list.innerHTML = '<div style="color:#888;margin-bottom:8px;">Bulduƒüun ƒ∞pu√ßlarƒ±:</div>';
    
    for (let i = 1; i <= 3; i++) {
        const found = G.clueAnswers.find(c => c.pos === i);
        const div = document.createElement('div');
        div.className = 'clue-item ' + (found ? 'found' : 'missing');
        div.textContent = found ? `${i}. rakam: ${found.digit}` : `${i}. rakam: ???`;
        list.appendChild(div);
    }
    
    let display = '';
    for (let i = 1; i <= 3; i++) {
        const found = G.clueAnswers.find(c => c.pos === i);
        display += found ? found.digit : '_';
        if (i < 3) display += ' ';
    }
    $('safe-display').textContent = display;
}

function submitSafe() {
    const input = $('safe-input').value.trim();
    
    if (input === G.safeCode) {
        $('safe-feedback').innerHTML = '<span class="correct">‚úì Kasa a√ßƒ±ldƒ±!</span>';
        G.hasKey = true;
        updateHUD();
        showMsg('üîë Anahtar bulundu! √áƒ±kƒ±≈üa git!', 3000);
        setTimeout(() => {
            $('safe-modal').classList.remove('active');
            renderRoom();
        }, 1200);
    } else {
        $('safe-feedback').innerHTML = '<span class="wrong">‚úó Yanlƒ±≈ü ≈üifre!</span>';
        $('safe-input').value = '';
    }
}

function closeSafe() {
    $('safe-modal').classList.remove('active');
}

// ==================== SAKLANMA ====================
function tryHide(furniture) {
    if (G.hiding || G.currentPuzzle) return;
    
    G.hiding = true;
    G.hideSpot = furniture;
    G.px = furniture.x + furniture.w/2 - 14;
    G.py = furniture.y + furniture.h/2 - 21;
    $('player').classList.add('hiding');
    $('hide-modal').classList.add('active');
    $('hide-warning').classList.remove('show');
}

function exitHide() {
    if (G.hideSpot) {
        G.py = G.hideSpot.y + G.hideSpot.h + 8;
        if (G.py > 440) G.py = G.hideSpot.y - 50;
    }
    
    G.hiding = false;
    G.hideSpot = null;
    $('player').classList.remove('hiding');
    $('hide-modal').classList.remove('active');
    $('hide-warning').classList.remove('show');
    showMsg('Saklanmadan √ßƒ±ktƒ±n.', 800);
}

function updateHidingView() {
    if (!G.hideSpot) return;
    
    const peep = $('peephole');
    const warn = $('hide-warning');
    
    if (G.gRoom === G.room) {
        const fx = G.hideSpot.x + G.hideSpot.w/2;
        const fy = G.hideSpot.y + G.hideSpot.h/2;
        const d = dist(G.gx+18, G.gy+25, fx, fy);
        
        if (d < 90) {
            peep.textContent = 'üëÄ √áOK YAKIN!';
            peep.style.color = '#e74c3c';
            warn.classList.add('show');
            
            const chance = 0.003 * CHAPTERS[G.chapter-1].grandpaSpeed * (1 - CHARS[G.char].stealth * 0.8);
            if (Math.random() < chance) {
                exitHide();
                showMsg('üò≤ Dede seni buldu!', 2000);
                takeDamage(25 * CHAPTERS[G.chapter-1].damageMultiplier);
            }
        } else if (d < 180) {
            peep.textContent = 'üëÄ Yakla≈üƒ±yor...';
            peep.style.color = '#f39c12';
            warn.classList.remove('show');
        } else {
            peep.textContent = 'üëÄ Odada...';
            peep.style.color = '#888';
            warn.classList.remove('show');
        }
    } else {
        peep.textContent = '‚úì G√ºvende';
        peep.style.color = 'var(--teal)';
        warn.classList.remove('show');
    }
}

// ==================== WIN/LOSE ====================
function chapterWin() {
    G.running = false;
    clearInterval(timerInterval);
    
    G.completedChapters[G.chapter - 1] = true;
    saveProgress();
    
    const s = Math.floor((Date.now() - G.startTime) / 1000);
    const score = Math.floor((Math.max(0, 300-s) * 10 + G.hp * 5 + G.energy * 2) * (G.chapter * 0.5 + 0.5));
    
    try {
        const saved = JSON.parse(localStorage.getItem('dedeEviProgress')) || {};
        if (!saved.highscore || score > saved.highscore) {
            saved.highscore = score;
            localStorage.setItem('dedeEviProgress', JSON.stringify(saved));
        }
    } catch(e) {}
    
    if (G.chapter < 3) {
        $('win-text').textContent = `B√∂l√ºm ${G.chapter} tamamlandƒ±! Maceran devam ediyor...`;
        $('next-chapter-btn').style.display = 'inline-block';
        $('next-chapter-btn').textContent = `B√ñL√úM ${G.chapter + 1}`;
    } else {
        $('win-text').innerHTML = `<span style="color:var(--gold)">T√úM B√ñL√úMLER TAMAM!</span><br>Dedenin evinden ba≈üarƒ±yla √ßƒ±ktƒ±n!`;
        $('next-chapter-btn').style.display = 'none';
    }
    
    $('win-stats').innerHTML = `‚è±Ô∏è ${formatTime(s)} | ‚ù§Ô∏è ${Math.round(G.hp)} | ‚ö° ${Math.round(G.energy)}`;
    $('win-score').textContent = `üèÜ ${score} PUAN`;
    $('win-modal').classList.add('active');
}

function gameOver() {
    G.running = false;
    clearInterval(timerInterval);
    
    const s = Math.floor((Date.now() - G.startTime) / 1000);
    $('lose-stats').innerHTML = `‚è±Ô∏è ${formatTime(s)} | üìú ${G.cluesFound}/3`;
    $('gameover-modal').classList.add('active');
}

function nextChapter() {
    G.chapter++;
    document.querySelectorAll('.modal').forEach(m => m.classList.remove('active'));
    startGame();
}

function restart() {
    document.querySelectorAll('.modal').forEach(m => m.classList.remove('active'));
    startGame();
}

function toMenu() {
    G.running = false;
    clearInterval(timerInterval);
    document.querySelectorAll('.modal').forEach(m => m.classList.remove('active'));
    $('game').classList.remove('active');
    $('menu').classList.add('active');
    initMenu();
}

function togglePause() {
    if (!G.running) return;
    G.paused = !G.paused;
    
    if (G.paused) {
        const s = Math.floor((Date.now() - G.startTime) / 1000);
        $('pause-stats').innerHTML = `‚è±Ô∏è ${formatTime(s)}<br>üìú ${G.cluesFound}/3 | üîë ${G.hasKey ? '‚úì' : '‚úó'}`;
        $('pause-modal').classList.add('active');
    } else {
        $('pause-modal').classList.remove('active');
    }
}

// ==================== INPUT - KLAVYE ====================
document.addEventListener('keydown', e => {
    if (!e || !e.key) return;
    
    // Input veya textarea aktifse oyun kontrollerini devre dƒ±≈üƒ± bƒ±rak
    const active = document.activeElement;
    const isTyping = active && (active.tagName === 'INPUT' || active.tagName === 'TEXTAREA');
    
    if (isTyping) {
        // Sadece ESC ve Enter'a izin ver
        if (e.key === 'Escape') {
            e.preventDefault();
            active.blur();
            if (G.currentPuzzle) closePuzzle();
            else if ($('safe-modal').classList.contains('active')) closeSafe();
        }
        return; // Diƒüer tu≈ülar input'a gitsin
    }
    
    const k = e.key.toLowerCase();
    
    if (k === 'w' || k === 'arrowup') { keys.w = true; e.preventDefault(); }
    if (k === 's' || k === 'arrowdown') { keys.s = true; e.preventDefault(); }
    if (k === 'a' || k === 'arrowleft') { keys.a = true; e.preventDefault(); }
    if (k === 'd' || k === 'arrowright') { keys.d = true; e.preventDefault(); }
    if (k === 'shift') keys.shift = true;
    
    if (k === 'e' || k === ' ') {
        e.preventDefault();
        interact();
    }
    
    if (k === 'escape') {
        e.preventDefault();
        if (G.hiding) exitHide();
        else if (G.currentPuzzle) closePuzzle();
        else if ($('safe-modal').classList.contains('active')) closeSafe();
        else togglePause();
    }
});

document.addEventListener('keyup', e => {
    if (!e || !e.key) return;
    
    // Input aktifse tu≈ülarƒ± serbest bƒ±rakma
    const active = document.activeElement;
    const isTyping = active && (active.tagName === 'INPUT' || active.tagName === 'TEXTAREA');
    if (isTyping) return;
    
    const k = e.key.toLowerCase();
    
    if (k === 'w' || k === 'arrowup') keys.w = false;
    if (k === 's' || k === 'arrowdown') keys.s = false;
    if (k === 'a' || k === 'arrowleft') keys.a = false;
    if (k === 'd' || k === 'arrowright') keys.d = false;
    if (k === 'shift') keys.shift = false;
});

// ==================== INPUT - MOBƒ∞L ====================
function initMobileControls() {
    const zone = $('joystick-zone');
    const knob = $('joystick-knob');
    
    if (!zone || !knob) return;
    
    let startX, startY, zoneRect;
    
    function handleStart(e) {
        e.preventDefault();
        const touch = e.touches ? e.touches[0] : e;
        zoneRect = zone.getBoundingClientRect();
        startX = zoneRect.left + zoneRect.width / 2;
        startY = zoneRect.top + zoneRect.height / 2;
        joystick.active = true;
    }
    
    function handleMove(e) {
        if (!joystick.active) return;
        e.preventDefault();
        
        const touch = e.touches ? e.touches[0] : e;
        let dx = touch.clientX - startX;
        let dy = touch.clientY - startY;
        
        const maxDist = 40;
        const d = Math.sqrt(dx*dx + dy*dy);
        
        if (d > maxDist) {
            dx = (dx / d) * maxDist;
            dy = (dy / d) * maxDist;
        }
        
        joystick.dx = dx / maxDist;
        joystick.dy = dy / maxDist;
        
        knob.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
    }
    
    function handleEnd(e) {
        e.preventDefault();
        joystick.active = false;
        joystick.dx = 0;
        joystick.dy = 0;
        knob.style.transform = 'translate(-50%, -50%)';
    }
    
    // Touch events
    zone.addEventListener('touchstart', handleStart, { passive: false });
    zone.addEventListener('touchmove', handleMove, { passive: false });
    zone.addEventListener('touchend', handleEnd, { passive: false });
    zone.addEventListener('touchcancel', handleEnd, { passive: false });
    
    // Mouse events (for testing on desktop)
    zone.addEventListener('mousedown', handleStart);
    document.addEventListener('mousemove', e => { if (joystick.active) handleMove(e); });
    document.addEventListener('mouseup', handleEnd);
    
    // Action button - Etkile≈üim
    const btnAction = $('btn-action');
    if (btnAction) {
        btnAction.addEventListener('touchstart', e => {
            e.preventDefault();
            interact();
        }, { passive: false });
        btnAction.addEventListener('click', interact);
    }
    
    // Run button - Ko≈üma
    const btnRun = $('btn-run');
    if (btnRun) {
        btnRun.addEventListener('touchstart', e => {
            e.preventDefault();
            mobileRun = true;
            btnRun.style.transform = 'scale(0.9)';
        }, { passive: false });
        
        btnRun.addEventListener('touchend', e => {
            e.preventDefault();
            mobileRun = false;
            btnRun.style.transform = 'scale(1)';
        }, { passive: false });
        
        btnRun.addEventListener('touchcancel', e => {
            mobileRun = false;
            btnRun.style.transform = 'scale(1)';
        }, { passive: false });
    }
    
    // Pause button i√ßin touch
    const pauseBtn = $('pause-btn');
    if (pauseBtn) {
        pauseBtn.addEventListener('touchstart', e => {
            e.preventDefault();
            togglePause();
        }, { passive: false });
    }
}

// ==================== INIT ====================
document.addEventListener('DOMContentLoaded', () => {
    $('continue-intro').onclick = () => {
        $('intro-screen').classList.add('hidden');
        $('menu').classList.add('active');
        initMenu();
    };
    
    $('start-btn').onclick = startGame;
    
    $('puz-submit').onclick = submitPuzzle;
    $('puz-hint-btn').onclick = showPuzzleHint;
    $('puz-close').onclick = closePuzzle;
    $('puz-input').onkeypress = e => { if (e.key === 'Enter') submitPuzzle(); };
    
    $('safe-submit').onclick = submitSafe;
    $('safe-close').onclick = closeSafe;
    $('safe-input').onkeypress = e => { if (e.key === 'Enter') submitSafe(); };
    
    $('exit-hide-btn').onclick = exitHide;
    $('hide-modal').onclick = e => { if (e.target.id === 'hide-modal') exitHide(); };
    
    $('pause-btn').onclick = togglePause;
    $('resume-btn').onclick = () => { G.paused = false; $('pause-modal').classList.remove('active'); };
    $('restart-btn').onclick = restart;
    $('quit-btn').onclick = toMenu;
    
    $('retry-btn').onclick = restart;
    $('menu-btn1').onclick = toMenu;
    
    $('next-chapter-btn').onclick = nextChapter;
    $('menu-btn2').onclick = toMenu;
    
    initMobileControls();
    
    console.log('üè† Dedenin Gizemli Evi y√ºklendi!');
});
</script>
<script>
if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
        navigator.serviceWorker.register("sw.js")
            .then(reg => console.log("SW registered"))
            .catch(err => console.log("SW failed:", err));
    });
}
</script>
</body>
</html>
<script>
// Prevent double tap zoom
document.addEventListener('touchend', e => {
    const now = Date.now();
    if (now - (document.lastTouchEnd || 0) < 300) {
        e.preventDefault();
    }
    document.lastTouchEnd = now;
}, { passive: false });

// Prevent context menu
document.addEventListener('contextmenu', e => e.preventDefault());

// Fullscreen on tap for iOS
document.addEventListener('click', function enableFullscreen() {
    if (document.documentElement.requestFullscreen) {
        document.documentElement.requestFullscreen().catch(() => {});
    } else if (document.documentElement.webkitRequestFullscreen) {
        document.documentElement.webkitRequestFullscreen();
    }
    document.removeEventListener('click', enableFullscreen);
}, { once: true });
</script>
