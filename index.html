<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1a1a2e">
    <link rel="manifest" href="manifest.json">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Dede'nin Gizemli Evi</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&family=Press+Start+2P&display=swap');
        *{margin:0;padding:0;box-sizing:border-box}
        :root{--bg-dark:#1a1a2e;--bg-darker:#0f0f1a;--purple:#6b5b95;--purple-dark:#4a3f6b;--gold:#f4d03f;--teal:#45b7aa;--pale:#e8e8e8}
        html,body{width:100%;height:100%;overflow:hidden;touch-action:none;-webkit-user-select:none;user-select:none;position:fixed}
        body{font-family:'VT323',monospace;background:var(--bg-darker);color:var(--pale)}
        #game-container{position:fixed;inset:0;background:var(--bg-dark);overflow:hidden}
        
        #intro-screen{position:absolute;inset:0;background:linear-gradient(180deg,#1a1a2e,#0f0f1a);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:200;padding:20px;text-align:center;padding-top:env(safe-area-inset-top)}
        #intro-screen.hidden{display:none}
        .story-title{font-family:'Press Start 2P',monospace;font-size:clamp(12px,5vw,20px);color:var(--gold);text-shadow:0 0 20px rgba(244,208,63,0.5);margin-bottom:20px}
        .story-text{max-width:400px;font-size:clamp(13px,4vw,16px);line-height:1.7;margin-bottom:20px}
        .story-text .highlight{color:var(--gold)}
        .continue-btn{font-family:'Press Start 2P',monospace;font-size:clamp(9px,3vw,11px);padding:12px 25px;background:linear-gradient(180deg,var(--purple),var(--purple-dark));border:3px solid var(--gold);color:white;cursor:pointer;border-radius:4px}
        
        #menu{position:absolute;inset:0;display:none;flex-direction:column;align-items:center;padding:15px;background:linear-gradient(180deg,#1a1a2e,#0f0f1a);z-index:100;overflow-y:auto;padding-top:env(safe-area-inset-top)}
        #menu.active{display:flex}
        .game-title{font-family:'Press Start 2P',monospace;font-size:clamp(10px,4vw,16px);color:var(--gold);margin-bottom:5px;text-align:center}
        .game-subtitle{font-size:clamp(11px,3vw,14px);color:var(--teal);margin-bottom:15px}
        .menu-section{margin-bottom:12px;text-align:center;width:100%;max-width:350px}
        .section-title{font-size:11px;color:#888;margin-bottom:8px;text-transform:uppercase}
        .char-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;max-width:280px;margin:0 auto}
        .char-card{background:linear-gradient(180deg,#2a2a4e,#1a1a2e);border:2px solid #3a3a5e;padding:8px 4px;text-align:center;border-radius:6px}
        .char-card.selected{border-color:var(--gold);box-shadow:0 0 10px rgba(244,208,63,0.3)}
        .char-sprite{font-size:24px;margin-bottom:4px}
        .char-name{font-family:'Press Start 2P',monospace;font-size:6px;color:var(--gold);margin-bottom:2px}
        .char-stats{font-size:9px;color:#aaa}
        .chapter-select{display:flex;gap:6px;flex-wrap:wrap;justify-content:center}
        .chapter-btn{padding:8px 12px;font-family:'VT323',monospace;font-size:13px;background:#2a2a4e;border:2px solid #3a3a5e;color:var(--pale);border-radius:4px}
        .chapter-btn.selected{border-color:var(--gold);color:var(--gold)}
        .chapter-btn:disabled{opacity:0.4}
        .start-btn{font-family:'Press Start 2P',monospace;font-size:clamp(9px,3vw,12px);padding:12px 25px;background:linear-gradient(180deg,var(--teal),#2a8a7f);border:3px solid var(--gold);color:white;margin-top:12px;border-radius:4px}
        .start-btn:disabled{opacity:0.5}
        #highscore{margin-top:10px;color:var(--gold);font-size:12px}
        
        #game{position:absolute;inset:0;display:none;flex-direction:column}
        #game.active{display:flex}
        .hud{height:40px;min-height:40px;background:linear-gradient(180deg,#1a1a2e,#0f0f1a);border-bottom:2px solid #3a3a5e;display:flex;align-items:center;justify-content:space-between;padding:0 8px;padding-top:env(safe-area-inset-top);z-index:50}
        .hud-group{display:flex;align-items:center;gap:5px}
        .hud-item{display:flex;align-items:center;gap:2px;font-size:11px}
        .pixel-bar{width:35px;height:6px;background:#1a1a1a;border:1px solid #3a3a3a;overflow:hidden;border-radius:2px}
        .pixel-bar-fill{height:100%;transition:width 0.3s}
        .health-fill{background:linear-gradient(90deg,#e74c3c,#c0392b)}
        .energy-fill{background:linear-gradient(90deg,var(--teal),#2a8a7f)}
        .chapter-indicator{font-family:'Press Start 2P',monospace;font-size:6px;color:var(--purple)}
        .room-name{font-size:11px;color:var(--gold)}
        .timer{font-family:'Press Start 2P',monospace;font-size:7px;color:var(--pale)}
        .hud-stat{font-size:11px}
        .pause-btn{background:none;border:1px solid #3a3a5e;padding:3px 6px;color:var(--pale);font-size:12px;border-radius:3px}
        
        #game-area{flex:1;position:relative;overflow:hidden;background:var(--bg-dark)}
        #room-wrapper{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;overflow:hidden}
        #room{position:relative;width:800px;height:500px;transform-origin:center center}
        
        .room-salon{background:radial-gradient(ellipse at 20% 20%,rgba(107,91,149,0.1) 0%,transparent 50%),linear-gradient(180deg,#2d2d4a,#1a1a30)}
        .room-mutfak{background:radial-gradient(ellipse at 80% 30%,rgba(69,183,170,0.08) 0%,transparent 50%),linear-gradient(180deg,#2a3d4a,#1a2530)}
        .room-yatak{background:radial-gradient(ellipse at 50% 50%,rgba(149,91,107,0.1) 0%,transparent 50%),linear-gradient(180deg,#3d2d4a,#251a30)}
        .room-bodrum{background:radial-gradient(ellipse at 30% 70%,rgba(80,80,100,0.1) 0%,transparent 50%),linear-gradient(180deg,#252535,#151520)}
        .room-floor{position:absolute;bottom:0;left:0;right:0;height:100px;background:repeating-linear-gradient(90deg,#5a4a3a 0px,#5a4a3a 40px,#6a5a4a 40px,#6a5a4a 80px);border-top:3px solid #3a2a1a}
        .furniture{position:absolute;display:flex;align-items:center;justify-content:center;font-size:20px;border:2px solid;border-color:#7a6a5a #4a3a2a #4a3a2a #7a6a5a;box-shadow:inset -3px -3px 0 rgba(0,0,0,0.4),inset 3px 3px 0 rgba(255,255,255,0.15);border-radius:3px}
        .door{position:absolute;background:linear-gradient(180deg,#7a6a5a,#5a4a3a);border:3px solid;border-color:#9a8a7a #4a3a2a #4a3a2a #9a8a7a;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:14px;z-index:10;border-radius:3px}
        .door::before{content:'';position:absolute;right:6px;top:50%;transform:translateY(-50%);width:6px;height:6px;background:radial-gradient(circle,var(--gold),#aa8800);border-radius:50%}
        .door-label{font-size:7px;color:rgba(255,255,255,0.7);margin-top:3px}
        .door.exit{background:linear-gradient(180deg,#4a7a5a,#3a5a4a);border-color:#6a9a7a #2a4a3a #2a4a3a #6a9a7a}
        .door.exit.locked{background:linear-gradient(180deg,#6a5050,#4a3535)}
        .door.exit.locked::after{content:'üîí';position:absolute;font-size:12px;top:50%;left:50%;transform:translate(-50%,-50%)}
        .puzzle-obj{position:absolute;font-size:24px;z-index:15;filter:drop-shadow(0 0 6px rgba(244,208,63,0.5));animation:float 3s ease-in-out infinite}
        @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-5px)}}
        .clue-obj{position:absolute;font-size:20px;z-index:15;filter:drop-shadow(0 0 5px rgba(69,183,170,0.6));animation:float 2.5s ease-in-out infinite}
        .player{position:absolute;width:28px;height:42px;z-index:40;display:flex;align-items:center;justify-content:center;font-size:22px;filter:drop-shadow(2px 2px 2px rgba(0,0,0,0.5))}
        .player.hiding{opacity:0.3;transform:scale(0.9)}
        .player.hurt{animation:hurtBlink 0.12s linear 4}
        @keyframes hurtBlink{0%,100%{opacity:1}50%{opacity:0.3}}
        .grandpa{position:absolute;width:36px;height:50px;display:none;align-items:center;justify-content:center;font-size:26px;z-index:35;filter:drop-shadow(2px 2px 2px rgba(0,0,0,0.5))}
        .grandpa.visible{display:flex}
        .grandpa.chasing{animation:grandpaChase 0.2s infinite}
        @keyframes grandpaChase{0%,100%{transform:translateY(0) rotate(-2deg)}50%{transform:translateY(-3px) rotate(2deg)}}
        .msg{position:absolute;top:8px;left:50%;transform:translateX(-50%);background:rgba(15,15,26,0.95);border:2px solid var(--purple);padding:6px 12px;font-size:11px;display:none;z-index:60;max-width:90%;text-align:center;border-radius:6px}
        .msg.show{display:block}
        .minimap{position:absolute;bottom:8px;right:8px;width:60px;height:48px;background:rgba(15,15,26,0.9);border:2px solid #3a3a5e;display:grid;grid-template-columns:1fr 1fr;grid-template-rows:1fr 1fr;gap:2px;padding:2px;z-index:50;border-radius:3px}
        .map-room{background:#2a2a4e;display:flex;align-items:center;justify-content:center;font-size:5px;color:#666;border-radius:2px}
        .map-room.current{background:var(--purple-dark);color:white}
        .map-room.has-grandpa::after{content:'üëÄ';font-size:6px}
        
        #mobile-controls{height:110px;min-height:110px;background:linear-gradient(180deg,rgba(26,26,46,0.95),rgba(15,15,26,0.98));border-top:2px solid #3a3a5e;display:flex;justify-content:space-between;align-items:center;padding:8px 15px;padding-bottom:calc(8px + env(safe-area-inset-bottom));z-index:80}
        #joystick-zone{width:90px;height:90px;background:rgba(58,58,94,0.6);border:2px solid #5a5a7e;border-radius:50%;position:relative}
        #joystick-knob{width:40px;height:40px;background:linear-gradient(145deg,var(--teal),#2a8a7f);border:2px solid var(--gold);border-radius:50%;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%)}
        .mobile-btns{display:flex;gap:10px}
        .mobile-btn{width:55px;height:55px;border-radius:50%;border:2px solid;font-size:22px;display:flex;align-items:center;justify-content:center}
        .mobile-btn:active{transform:scale(0.9)}
        #btn-action{background:linear-gradient(145deg,var(--purple),var(--purple-dark));border-color:var(--gold)}
        #btn-run{background:linear-gradient(145deg,var(--teal),#2a8a7f);border-color:var(--gold)}
        
        .modal{position:absolute;inset:0;display:none;justify-content:center;align-items:center;background:rgba(0,0,0,0.9);z-index:500;padding:12px}
        .modal.active{display:flex}
        .modal-box{background:linear-gradient(180deg,#2a2a4e,#1a1a2e);border:2px solid var(--purple);padding:18px;text-align:center;max-width:92%;max-height:85%;overflow-y:auto;border-radius:10px}
        .modal-title{font-family:'Press Start 2P',monospace;font-size:clamp(9px,3vw,12px);color:var(--gold);margin-bottom:10px}
        .modal-text{font-size:14px;line-height:1.4;margin-bottom:10px}
        .modal-input{width:100%;max-width:160px;padding:10px;font-family:'VT323',monospace;font-size:20px;text-align:center;background:#0f0f1a;border:2px solid #3a3a5e;color:var(--gold);margin-bottom:8px;border-radius:6px}
        .modal-input:focus{outline:none;border-color:var(--teal)}
        .modal-btns{display:flex;gap:6px;justify-content:center;flex-wrap:wrap}
        .btn{font-family:'VT323',monospace;font-size:14px;padding:8px 14px;border:2px solid;border-radius:5px}
        .btn-teal{background:linear-gradient(180deg,var(--teal),#2a8a7f);border-color:var(--gold);color:white}
        .btn-purple{background:linear-gradient(180deg,var(--purple),var(--purple-dark));border-color:var(--gold);color:white}
        .btn-gray{background:linear-gradient(180deg,#444,#2a2a2a);border-color:#666;color:#aaa}
        .feedback{font-size:13px;margin:5px 0;min-height:16px}
        .feedback.correct{color:var(--teal)}
        .feedback.wrong{color:#e74c3c}
        .hint{font-size:12px;color:var(--gold);margin:5px 0}
        .hiding-text{font-size:18px;color:var(--teal);margin-bottom:10px}
        .peephole{width:70px;height:70px;margin:0 auto 10px;background:radial-gradient(circle,#1a1a2e,#000 70%);border:2px solid #3a3a5e;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px}
        .hide-warning{color:#e74c3c;font-size:13px;margin-top:6px;display:none}
        .hide-warning.show{display:block;animation:pulse 0.5s infinite}
        @keyframes pulse{50%{opacity:0.5}}
        #chapter-transition{position:absolute;inset:0;background:#000;display:none;flex-direction:column;align-items:center;justify-content:center;z-index:600;padding:20px}
        #chapter-transition.active{display:flex}
        .chapter-title{font-family:'Press Start 2P',monospace;font-size:clamp(11px,4vw,16px);color:var(--gold);margin-bottom:10px}
        .chapter-subtitle{font-size:15px;color:var(--pale)}
        .win-title{font-family:'Press Start 2P',monospace;font-size:clamp(11px,4vw,16px);color:var(--teal);margin-bottom:10px}
        .lose-title{font-family:'Press Start 2P',monospace;font-size:clamp(11px,4vw,16px);color:#e74c3c;margin-bottom:10px}
        .score{font-family:'Press Start 2P',monospace;font-size:clamp(9px,3vw,12px);color:var(--gold);margin:10px 0}
        .safe-display{font-family:'Press Start 2P',monospace;font-size:clamp(14px,5vw,20px);color:var(--teal);background:#0f0f1a;padding:8px 18px;margin-bottom:10px;border:2px solid #3a3a5e;letter-spacing:5px;border-radius:6px}
        .clue-list{text-align:left;margin:8px 0;padding:8px;background:rgba(0,0,0,0.3);border:1px solid #3a3a5e;border-radius:5px}
        .clue-item{margin:4px 0;font-size:12px}
        .clue-item.found{color:var(--gold)}
        .clue-item.missing{color:#666}
    </style>
</head>
<body>
<div id="game-container">
    <div id="intro-screen">
        <h1 class="story-title">üè† DEDENƒ∞N Gƒ∞ZEMLƒ∞ EVƒ∞</h1>
        <div class="story-text">
            <p>Yƒ±llardƒ±r kapalƒ± <span class="highlight">aile malik√¢nesi</span>ne ho≈ü geldin!</p><br>
            <p>Deden <span class="highlight">Necmi</span> burada ya≈üardƒ±. Kapƒ± arkandan kapandƒ±!</p><br>
            <p>Bulmacalarƒ± √ß√∂z, kasayƒ± a√ß, anahtarƒ± al ve ka√ß!</p><br>
            <p style="font-size:12px;color:#888;">üß© 3 bulmaca ‚Üí üîê Kasa ‚Üí üîë Anahtar ‚Üí üö™ Ka√ß!</p>
        </div>
        <button class="continue-btn" id="continue-intro">BA≈ûLA</button>
    </div>
    
    <div id="menu">
        <h1 class="game-title">üè† DEDENƒ∞N Gƒ∞ZEMLƒ∞ EVƒ∞</h1>
        <p class="game-subtitle">‚ú® Bulmaca & Ka√ßƒ±≈ü ‚ú®</p>
        <div class="menu-section">
            <div class="section-title">Karakter Se√ß</div>
            <div class="char-grid" id="char-grid"></div>
        </div>
        <div class="menu-section">
            <div class="section-title">B√∂l√ºm</div>
            <div class="chapter-select" id="chapter-select"></div>
        </div>
        <button class="start-btn" id="start-btn" disabled>üéÆ BA≈ûLA</button>
        <div id="highscore"></div>
    </div>
    
    <div id="game">
        <div class="hud">
            <div class="hud-group">
                <div class="hud-item">‚ù§Ô∏è<div class="pixel-bar"><div class="pixel-bar-fill health-fill" id="health-bar" style="width:100%"></div></div></div>
                <div class="hud-item">‚ö°<div class="pixel-bar"><div class="pixel-bar-fill energy-fill" id="energy-bar" style="width:100%"></div></div></div>
            </div>
            <div class="hud-group">
                <span class="chapter-indicator" id="chapter-ind">B1</span>
                <span class="room-name" id="room-name">SALON</span>
            </div>
            <div class="hud-group">
                <span class="hud-stat">üìú<span id="clue-count">0</span>/3</span>
                <span class="hud-stat" id="key-indicator">üîë‚ùå</span>
                <span class="timer" id="timer">00:00</span>
                <button class="pause-btn" id="pause-btn">‚è∏</button>
            </div>
        </div>
        
        <div id="game-area">
            <div id="room-wrapper">
                <div id="room">
                    <div class="player" id="player">üßë</div>
                    <div class="grandpa" id="grandpa">üë¥</div>
                </div>
            </div>
            <div class="msg" id="msg"></div>
            <div class="minimap" id="minimap"></div>
        </div>
        
        <div id="mobile-controls">
            <div id="joystick-zone"><div id="joystick-knob"></div></div>
            <div class="mobile-btns">
                <button class="mobile-btn" id="btn-action">üîç</button>
                <button class="mobile-btn" id="btn-run">üèÉ</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="puzzle-modal"><div class="modal-box">
        <div class="modal-title">üß© BULMACA</div>
        <div class="modal-text" id="puz-text"></div>
        <input type="text" class="modal-input" id="puz-input" placeholder="?" autocomplete="off">
        <div class="feedback" id="puz-feedback"></div>
        <div class="hint" id="puz-hint"></div>
        <div class="modal-btns">
            <button class="btn btn-teal" id="puz-submit">CEVAPLA</button>
            <button class="btn btn-gray" id="puz-hint-btn">üí°</button>
            <button class="btn btn-gray" id="puz-close">KAPAT</button>
        </div>
    </div></div>
    
    <div class="modal" id="safe-modal"><div class="modal-box">
        <div class="modal-title">üîê KASA</div>
        <div class="safe-display" id="safe-display">_ _ _</div>
        <div class="clue-list" id="clue-list"></div>
        <input type="text" class="modal-input" id="safe-input" placeholder="3 hane" maxlength="3" autocomplete="off">
        <div class="feedback" id="safe-feedback"></div>
        <div class="modal-btns">
            <button class="btn btn-teal" id="safe-submit">Gƒ∞R</button>
            <button class="btn btn-gray" id="safe-close">KAPAT</button>
        </div>
    </div></div>
    
    <div class="modal" id="hide-modal"><div class="modal-box">
        <div class="hiding-text">ü§´ Saklanƒ±yorsun...</div>
        <div class="peephole" id="peephole">‚úì G√ºvende</div>
        <button class="btn btn-purple" id="exit-hide-btn">üö™ √áIK</button>
        <div class="hide-warning" id="hide-warning">‚ö†Ô∏è Dede yakƒ±nda!</div>
    </div></div>
    
    <div class="modal" id="pause-modal"><div class="modal-box">
        <div class="modal-title">‚è∏ DURAKLADI</div>
        <div id="pause-stats" style="margin:10px 0;color:#888;"></div>
        <div class="modal-btns" style="flex-direction:column;gap:6px;">
            <button class="btn btn-teal" id="resume-btn">‚ñ∂ DEVAM</button>
            <button class="btn btn-gray" id="restart-btn">üîÑ YENƒ∞DEN</button>
            <button class="btn btn-purple" id="quit-btn">üè† MEN√ú</button>
        </div>
    </div></div>
    
    <div class="modal" id="gameover-modal"><div class="modal-box">
        <h2 class="lose-title">üòÖ YAKALANDIN!</h2>
        <p class="modal-text">Tekrar dene!</p>
        <div id="lose-stats" style="color:#888;margin-bottom:10px;"></div>
        <div class="modal-btns">
            <button class="btn btn-teal" id="retry-btn">üîÑ TEKRAR</button>
            <button class="btn btn-purple" id="menu-btn1">üè† MEN√ú</button>
        </div>
    </div></div>
    
    <div class="modal" id="win-modal"><div class="modal-box">
        <h2 class="win-title">üéâ TAMAM!</h2>
        <p class="modal-text" id="win-text">Evden ka√ßtƒ±n!</p>
        <div id="win-stats" style="color:#888;margin-bottom:6px;"></div>
        <div class="score" id="win-score">üèÜ 0</div>
        <div class="modal-btns">
            <button class="btn btn-teal" id="next-chapter-btn">SONRAKƒ∞</button>
            <button class="btn btn-purple" id="menu-btn2">üè† MEN√ú</button>
        </div>
    </div></div>
    
    <div id="chapter-transition">
        <h1 class="chapter-title" id="trans-title">B√ñL√úM 1</h1>
        <p class="chapter-subtitle" id="trans-subtitle">Gizemli Salon</p>
    </div>
</div>

<script>
const CHARS={cocuk:{name:'√áOCUK',emoji:'üßí',hp:100,spd:3.5},kiz:{name:'KIZ',emoji:'üëß',hp:90,spd:4},oglan:{name:'OƒûLAN',emoji:'üë¶',hp:110,spd:3.2},bebek:{name:'Mƒ∞Nƒ∞K',emoji:'üë∂',hp:80,spd:4.5},nine:{name:'Nƒ∞NE',emoji:'üëµ',hp:120,spd:2.8},kedi:{name:'KEDƒ∞',emoji:'üê±',hp:70,spd:5}};
const CHAPTERS=[{id:1,name:'B√ñL√úM 1',story:'Bulmacalarƒ± √ß√∂z!'},{id:2,name:'B√ñL√úM 2',story:'Dede daha hƒ±zlƒ±!'},{id:3,name:'B√ñL√úM 3',story:'Son ka√ßƒ±≈ü!'}];
const PUZZLES_EASY=[{q:'2+2=?',a:'4',h:'D√∂rt'},{q:'3+3=?',a:'6',h:'Altƒ±'},{q:'5+3=?',a:'8',h:'Sekiz'},{q:'10-5=?',a:'5',h:'Be≈ü'},{q:'Elde ka√ß parmak?',a:'5',h:'Say'},{q:'G√∂ky√ºz√º rengi?',a:'mavi',h:'Yukarƒ± bak'},{q:'Haftada ka√ß g√ºn?',a:'7',h:'Pazartesi-Pazar'},{q:'K√∂pek sesi?',a:'hav',h:'Hav hav'},{q:'Kedi sesi?',a:'miyav',h:'Miyav'},{q:'ƒ∞nek ne verir?',a:'sut',h:'Beyaz'}];
const PUZZLES_MEDIUM=[{q:'5+7=?',a:'12',h:'12'},{q:'15-8=?',a:'7',h:'7'},{q:'4x3=?',a:'12',h:'12'},{q:'2,4,6,8,?',a:'10',h:'ƒ∞ki≈üer'},{q:'Yƒ±lda ka√ß ay?',a:'12',h:'12'},{q:'√ú√ßgenin k√∂≈üesi?',a:'3',h:'√ú√ß'}];
const PUZZLES_HARD=[{q:'18+15=?',a:'33',h:'33'},{q:'6x4=?',a:'24',h:'24'},{q:'100-45=?',a:'55',h:'55'},{q:'Ba≈ükent?',a:'ankara',h:'ƒ∞stanbul deƒüil'},{q:'G√∂kku≈üaƒüƒ± renk?',a:'7',h:'Yedi'}];
const PUZZLE_POOLS={1:PUZZLES_EASY,2:PUZZLES_MEDIUM,3:PUZZLES_HARD};
const ROOMS={salon:{name:'SALON',bg:'room-salon',furniture:[{x:20,y:150,w:100,h:45,icon:'üõãÔ∏è',c:'#6b5344'},{x:20,y:220,w:55,h:45,icon:'ü™ë',c:'#5a4535'},{x:140,y:100,w:70,h:45,icon:'üì∫',c:'#2a2a3a'},{x:680,y:150,w:65,h:90,icon:'üóÑÔ∏è',c:'#4a3a2a',hide:true}],puzzleSpots:[{x:350,y:100,icon:'üñºÔ∏è'}],clueSpot:{x:580,y:390,icon:'üìú'},doors:[{x:755,y:280,w:25,h:70,to:'mutfak',dir:'right'},{x:380,y:55,w:70,h:25,to:'yatak',dir:'top'}],patrol:[{x:200,y:330},{x:480,y:380},{x:620,y:330}]},mutfak:{name:'MUTFAK',bg:'room-mutfak',furniture:[{x:20,y:100,w:55,h:90,icon:'üßä',c:'#8a9a9a'},{x:20,y:210,w:90,h:40,icon:'üç≥',c:'#7a6a5a'},{x:660,y:360,w:75,h:65,icon:'üì¶',c:'#5a4a3a',hide:true}],puzzleSpots:[{x:480,y:100,icon:'üìñ'}],clueSpot:{x:330,y:390,icon:'üìú'},doors:[{x:0,y:280,w:25,h:70,to:'salon',dir:'left'},{x:380,y:55,w:70,h:25,to:'bodrum',dir:'top'}],patrol:[{x:280,y:330},{x:520,y:380},{x:380,y:330}]},yatak:{name:'YATAK',bg:'room-yatak',furniture:[{x:20,y:120,w:120,h:65,icon:'üõèÔ∏è',c:'#5a4a4a',hide:true},{x:20,y:210,w:55,h:90,icon:'üö™',c:'#4a3a2a',hide:true},{x:660,y:190,w:75,h:45,icon:'üíª',c:'#3a3a4a'}],puzzleSpots:[{x:380,y:100,icon:'üñºÔ∏è'}],clueSpot:{x:530,y:390,icon:'üìú'},safeSpot:{x:660,y:390},doors:[{x:380,y:450,w:70,h:25,to:'salon',dir:'bottom'},{x:755,y:280,w:25,h:70,to:'bodrum',dir:'right'}],patrol:[{x:240,y:330},{x:480,y:380},{x:380,y:360}]},bodrum:{name:'BODRUM',bg:'room-bodrum',furniture:[{x:20,y:120,w:45,h:45,icon:'üì¶',c:'#4a3a2a'},{x:630,y:330,w:85,h:75,icon:'üì¶',c:'#5a4a3a',hide:true}],puzzleSpots:[],clueSpot:null,doors:[{x:380,y:450,w:70,h:25,to:'mutfak',dir:'bottom'},{x:0,y:280,w:25,h:70,to:'yatak',dir:'left'},{x:700,y:85,w:55,h:45,to:'exit',dir:'right',isExit:true}],patrol:[{x:190,y:330},{x:430,y:380},{x:330,y:360}]}};
const ENTRY={left:{x:90,y:320},right:{x:660,y:320},top:{x:380,y:190},bottom:{x:380,y:360}};

let G={running:false,paused:false,chapter:1,room:'salon',char:null,hp:100,maxHp:100,energy:100,cluesFound:0,clueAnswers:[],hasKey:false,hiding:false,invincible:false,px:380,py:280,gx:100,gy:280,gRoom:'mutfak',gChasing:false,gPatrolIdx:0,gRoomDelay:200,startTime:0,currentPuzzle:null,roomPuzzles:{},roomClues:{},safeCode:'',completedChapters:[false,false,false],scale:1};
let keys={w:false,a:false,s:false,d:false,shift:false};
let joystick={active:false,dx:0,dy:0};
let mobileRun=false,msgTimeout=null,timerInterval=null;

const $=id=>document.getElementById(id);
const dist=(x1,y1,x2,y2)=>Math.sqrt((x2-x1)**2+(y2-y1)**2);
const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
const collides=(a,b)=>a.x<b.x+b.w&&a.x+a.w>b.x&&a.y<b.y+b.h&&a.y+a.h>b.y;
const shuffle=arr=>[...arr].sort(()=>Math.random()-0.5);
function vibrate(p=50){if('vibrate'in navigator)navigator.vibrate(p)}
function showMsg(t,d=2500){const e=$('msg');e.innerHTML=t;e.classList.add('show');clearTimeout(msgTimeout);msgTimeout=setTimeout(()=>e.classList.remove('show'),d)}
function formatTime(s){return Math.floor(s/60).toString().padStart(2,'0')+':'+(s%60).toString().padStart(2,'0')}

function updateScale(){
    const ga=$('game-area'),r=$('room');if(!ga||!r)return;
    const aW=ga.clientWidth,aH=ga.clientHeight,rW=800,rH=500;
    G.scale=Math.min(aW/rW,aH/rH,1.2);
    r.style.transform=`scale(${G.scale})`;
}
window.addEventListener('resize',updateScale);

function generatePuzzles(){
    const pool=PUZZLE_POOLS[G.chapter]||PUZZLES_EASY;
    const sel=shuffle([...pool]).slice(0,3);
    const code=[Math.floor(Math.random()*9)+1,Math.floor(Math.random()*10),Math.floor(Math.random()*10)];
    G.safeCode=code.join('');
    G.roomPuzzles={};G.roomClues={};G.clueAnswers=[];
    G.roomPuzzles['salon']=[{...sel[0],digit:code[0],digitPos:1,solved:false}];
    G.roomClues['salon']={found:false,digit:code[0],pos:1};
    G.roomPuzzles['mutfak']=[{...sel[1],digit:code[1],digitPos:2,solved:false}];
    G.roomClues['mutfak']={found:false,digit:code[1],pos:2};
    G.roomPuzzles['yatak']=[{...sel[2],digit:code[2],digitPos:3,solved:false}];
    G.roomClues['yatak']={found:false,digit:code[2],pos:3};
}

function initMenu(){
    const g=$('char-grid');g.innerHTML='';
    for(const id in CHARS){const c=CHARS[id];const d=document.createElement('div');d.className='char-card';d.dataset.id=id;d.innerHTML=`<div class="char-sprite">${c.emoji}</div><div class="char-name">${c.name}</div><div class="char-stats">‚ù§${c.hp} ‚ö°${c.spd.toFixed(1)}</div>`;d.onclick=()=>selectChar(id);g.appendChild(d)}
    const ch=$('chapter-select');ch.innerHTML='';
    CHAPTERS.forEach((c,i)=>{const b=document.createElement('button');b.className='chapter-btn'+(i===0?' selected':'');b.textContent=`${c.id}. B√ñL√úM`;b.disabled=i>0&&!G.completedChapters[i-1];b.onclick=()=>selectChapter(c.id);ch.appendChild(b)});
    loadProgress();
}
function selectChar(id){vibrate(30);document.querySelectorAll('.char-card').forEach(c=>c.classList.remove('selected'));document.querySelector(`[data-id="${id}"]`).classList.add('selected');G.char=id;$('start-btn').disabled=false}
function selectChapter(id){vibrate(30);G.chapter=id;document.querySelectorAll('.chapter-btn').forEach((b,i)=>b.classList.toggle('selected',i===id-1))}
function loadProgress(){try{const s=JSON.parse(localStorage.getItem('dedeEviProgress'));if(s){G.completedChapters=s.chapters||[false,false,false];document.querySelectorAll('.chapter-btn').forEach((b,i)=>{b.disabled=i>0&&!G.completedChapters[i-1]});if(s.highscore)$('highscore').textContent=`üèÜ ${s.highscore}`}}catch(e){}}
function saveProgress(){try{const s=JSON.parse(localStorage.getItem('dedeEviProgress'))||{};s.chapters=G.completedChapters;localStorage.setItem('dedeEviProgress',JSON.stringify(s))}catch(e){}}

function startGame(){
    if(!G.char)return;vibrate(50);
    const c=CHARS[G.char];
    G.maxHp=c.hp;G.hp=c.hp;G.energy=100;G.running=true;G.paused=false;
    G.room='salon';G.px=380;G.py=280;G.gx=100;G.gy=280;G.gRoom='mutfak';
    G.gChasing=false;G.gPatrolIdx=0;G.gRoomDelay=200;
    G.cluesFound=0;G.clueAnswers=[];G.hasKey=false;G.hiding=false;G.invincible=false;
    G.startTime=Date.now();G.currentPuzzle=null;
    generatePuzzles();
    $('menu').classList.remove('active');$('game').classList.add('active');
    $('player').textContent=c.emoji;$('chapter-ind').textContent=`B${G.chapter}`;
    setTimeout(updateScale,50);renderRoom();updateHUD();
    showChapterTransition(CHAPTERS[G.chapter-1],()=>{timerInterval=setInterval(updateTimer,1000);requestAnimationFrame(gameLoop)});
}
function showChapterTransition(ch,cb){$('trans-title').textContent=ch.name;$('trans-subtitle').textContent=ch.story;$('chapter-transition').classList.add('active');setTimeout(()=>{$('chapter-transition').classList.remove('active');showMsg('üîç Bulmacalarƒ± √ß√∂z!',2500);cb()},1800)}

function renderRoom(){
    const room=ROOMS[G.room],el=$('room'),p=$('player'),g=$('grandpa');
    el.innerHTML='';el.appendChild(p);el.appendChild(g);el.className=room.bg;
    const fl=document.createElement('div');fl.className='room-floor';el.appendChild(fl);
    room.furniture.forEach(f=>{const d=document.createElement('div');d.className='furniture'+(f.hide?' hideable':'');d.style.cssText=`left:${f.x}px;top:${f.y}px;width:${f.w}px;height:${f.h}px;background:${f.c}`;d.innerHTML=f.icon;el.appendChild(d)});
    if(G.roomPuzzles[G.room]){const spots=room.puzzleSpots;G.roomPuzzles[G.room].forEach((p,i)=>{if(p.solved)return;const sp=spots[i]||spots[0];if(!sp)return;const d=document.createElement('div');d.className='puzzle-obj';d.style.cssText=`left:${sp.x}px;top:${sp.y}px`;d.textContent=sp.icon;el.appendChild(d)})}
    if(room.clueSpot&&G.roomClues[G.room]&&!G.roomClues[G.room].found){const d=document.createElement('div');d.className='clue-obj';d.style.cssText=`left:${room.clueSpot.x}px;top:${room.clueSpot.y}px`;d.textContent=room.clueSpot.icon;el.appendChild(d)}
    if(G.room==='yatak'&&!G.hasKey&&room.safeSpot){const d=document.createElement('div');d.className='puzzle-obj';d.style.cssText=`left:${room.safeSpot.x}px;top:${room.safeSpot.y}px;font-size:28px`;d.textContent='üîê';el.appendChild(d)}
    room.doors.forEach(dr=>{const d=document.createElement('div');let cls='door';if(dr.isExit)cls+=' exit'+(!G.hasKey?' locked':'');d.className=cls;d.style.cssText=`left:${dr.x}px;top:${dr.y}px;width:${dr.w}px;height:${dr.h}px`;const arr={left:'‚óÄ',right:'‚ñ∂',top:'‚ñ≤',bottom:'‚ñº'};if(!dr.isExit)d.innerHTML=`<span style="font-size:13px">${arr[dr.dir]}</span><span class="door-label">${ROOMS[dr.to]?.name.substring(0,3)||''}</span>`;el.appendChild(d)});
    $('room-name').textContent=room.name;updateMinimap();
}
function updateHUD(){$('health-bar').style.width=(G.hp/G.maxHp*100)+'%';$('energy-bar').style.width=G.energy+'%';$('clue-count').textContent=G.cluesFound;$('key-indicator').textContent=G.hasKey?'üîë‚úì':'üîë‚ùå'}
function updateTimer(){if(!G.running||G.paused)return;const s=Math.floor((Date.now()-G.startTime)/1000);$('timer').textContent=formatTime(s)}
function updateMinimap(){const m=$('minimap');m.innerHTML='';[{id:'yatak',name:'YTK'},{id:'bodrum',name:'BOD'},{id:'salon',name:'SAL'},{id:'mutfak',name:'MUT'}].forEach(r=>{const d=document.createElement('div');d.className='map-room'+(r.id===G.room?' current':'')+(r.id===G.gRoom?' has-grandpa':'');d.textContent=r.name;m.appendChild(d)})}

function gameLoop(){
    if(!G.running)return;
    const sa=$('safe-modal')?.classList.contains('active');
    if(!G.paused&&!G.hiding&&!G.currentPuzzle&&!sa){movePlayer();moveGrandpa();checkCollision()}
    if(G.hiding)updateHidingView();
    $('player').style.left=G.px+'px';$('player').style.top=G.py+'px';
    $('grandpa').style.left=G.gx+'px';$('grandpa').style.top=G.gy+'px';
    $('grandpa').classList.toggle('visible',G.gRoom===G.room);$('grandpa').classList.toggle('chasing',G.gChasing);
    $('grandpa').textContent=G.gChasing?'üßì':'üë¥';
    requestAnimationFrame(gameLoop);
}
function movePlayer(){
    const c=CHARS[G.char];if(!c)return;
    const run=(keys.shift||mobileRun)&&G.energy>10;let spd=c.spd*(run?1.8:1);
    let dx=0,dy=0;
    if(joystick.active){dx=joystick.dx*spd;dy=joystick.dy*spd}else{if(keys.w)dy-=spd;if(keys.s)dy+=spd;if(keys.a)dx-=spd;if(keys.d)dx+=spd;if(dx&&dy){dx*=0.707;dy*=0.707}}
    if(dx===0&&dy===0){G.energy=Math.min(100,G.energy+0.2);updateHUD();return}
    if(run)G.energy=Math.max(0,G.energy-0.4);else G.energy=Math.min(100,G.energy+0.1);
    const nX=G.px+dx,nY=G.py+dy,room=ROOMS[G.room];let cX=true,cY=true;
    for(const f of room.furniture){if(collides({x:nX,y:G.py,w:24,h:36},{x:f.x,y:f.y,w:f.w,h:f.h}))cX=false;if(collides({x:G.px,y:nY,w:24,h:36},{x:f.x,y:f.y,w:f.w,h:f.h}))cY=false}
    if(cX)G.px=clamp(nX,10,740);if(cY)G.py=clamp(nY,75,420);updateHUD();
}
function moveGrandpa(){
    const cs=1+(G.chapter-1)*0.3;
    if(G.gRoom===G.room&&!G.hiding){const d=dist(G.gx,G.gy,G.px,G.py);if(d<180){G.gChasing=true;const sp=2.2*cs,a=Math.atan2(G.py-G.gy,G.px-G.gx);G.gx+=Math.cos(a)*sp;G.gy+=Math.sin(a)*sp}else{G.gChasing=false;patrol()}}else{G.gChasing=false;patrol();G.gRoomDelay--;if(G.gRoomDelay<=0){const rs=Object.keys(ROOMS);G.gRoom=rs[(rs.indexOf(G.gRoom)+1)%rs.length];G.gx=380;G.gy=280;G.gRoomDelay=280-(G.chapter*45);updateMinimap()}}
}
function patrol(){const room=ROOMS[G.gRoom];if(!room?.patrol)return;const t=room.patrol[G.gPatrolIdx],d=dist(G.gx,G.gy,t.x,t.y);if(d<10)G.gPatrolIdx=(G.gPatrolIdx+1)%room.patrol.length;else{const a=Math.atan2(t.y-G.gy,t.x-G.gx);G.gx+=Math.cos(a)*1.1;G.gy+=Math.sin(a)*1.1}}
function checkCollision(){if(G.invincible||G.hiding)return;if(G.gRoom===G.room&&dist(G.px,G.py,G.gx,G.gy)<35)takeDamage(25)}
function takeDamage(a){if(G.invincible)return;G.hp-=a;vibrate([100,50,100]);$('player').classList.add('hurt');setTimeout(()=>$('player').classList.remove('hurt'),500);G.invincible=true;setTimeout(()=>G.invincible=false,1500);updateHUD();if(G.hp<=0)gameOver()}

function interact(){
    if(G.paused||!G.running)return;vibrate(30);if(G.hiding){exitHide();return}
    const room=ROOMS[G.room];
    for(const d of room.doors){if(dist(G.px,G.py,d.x+d.w/2,d.y+d.h/2)<55){if(d.isExit){if(G.hasKey)winChapter();else{showMsg('üîí Kilitli!',2000);vibrate([50,30,50])}}else changeRoom(d.to,d.dir);return}}
    if(G.roomPuzzles[G.room]){const spots=room.puzzleSpots;for(let i=0;i<G.roomPuzzles[G.room].length;i++){const p=G.roomPuzzles[G.room][i];if(p.solved)continue;const sp=spots[i]||spots[0];if(sp&&dist(G.px,G.py,sp.x,sp.y)<65){openPuzzle(p);return}}}
    if(room.clueSpot&&G.roomClues[G.room]&&!G.roomClues[G.room].found){if(dist(G.px,G.py,room.clueSpot.x,room.clueSpot.y)<65){collectClue();return}}
    if(G.room==='yatak'&&!G.hasKey&&room.safeSpot){if(dist(G.px,G.py,room.safeSpot.x,room.safeSpot.y)<65){openSafe();return}}
    for(const f of room.furniture){if(f.hide&&dist(G.px,G.py,f.x+f.w/2,f.y+f.h/2)<55){hideInFurniture(f);return}}
}
function changeRoom(roomId,fromDir){vibrate(40);G.room=roomId;const op={left:'right',right:'left',top:'bottom',bottom:'top'},en=ENTRY[op[fromDir]]||ENTRY.left;G.px=en.x;G.py=en.y;renderRoom();showMsg(`üìç ${ROOMS[roomId].name}`,1500)}

function openPuzzle(p){G.currentPuzzle=p;$('puz-text').textContent=p.q;$('puz-input').value='';$('puz-feedback').textContent='';$('puz-hint').textContent='';$('puzzle-modal').classList.add('active');setTimeout(()=>$('puz-input').focus(),100)}
function submitPuzzle(){if(!G.currentPuzzle)return;const inp=$('puz-input').value.trim().toLowerCase(),ans=G.currentPuzzle.a.toLowerCase();if(inp===ans){vibrate([50,30,100]);$('puz-feedback').textContent='‚úì Doƒüru!';$('puz-feedback').className='feedback correct';G.currentPuzzle.solved=true;showMsg(`üéØ Rakam: ${G.currentPuzzle.digit}`,3000);setTimeout(()=>{closePuzzle();renderRoom()},1000)}else{vibrate([100,50,100]);$('puz-feedback').textContent='‚úó Yanlƒ±≈ü!';$('puz-feedback').className='feedback wrong';$('puz-input').value=''}}
function showPuzzleHint(){if(G.currentPuzzle)$('puz-hint').textContent='üí° '+G.currentPuzzle.h}
function closePuzzle(){G.currentPuzzle=null;$('puzzle-modal').classList.remove('active')}

function collectClue(){const cl=G.roomClues[G.room];if(!cl||cl.found)return;vibrate([50,30,100]);cl.found=true;G.cluesFound++;G.clueAnswers.push({pos:cl.pos,digit:cl.digit});showMsg(`üìú ${cl.pos}. rakam: ${cl.digit}`,3000);updateHUD();renderRoom()}

function openSafe(){updateClueList();$('safe-input').value='';$('safe-feedback').textContent='';$('safe-display').textContent='_ _ _';$('safe-modal').classList.add('active');setTimeout(()=>$('safe-input').focus(),100)}
function updateClueList(){const l=$('clue-list');l.innerHTML='<div style="color:var(--gold);margin-bottom:5px;">üìú ƒ∞pu√ßlarƒ±:</div>';for(let i=1;i<=3;i++){const f=G.clueAnswers.find(c=>c.pos===i),d=document.createElement('div');d.className='clue-item '+(f?'found':'missing');d.textContent=f?`${i}. rakam: ${f.digit}`:`${i}. rakam: ???`;l.appendChild(d)}}
function submitSafe(){const inp=$('safe-input').value.trim();if(inp.length!==3||!/^\d+$/.test(inp)){$('safe-feedback').textContent='3 hane gir!';$('safe-feedback').className='feedback wrong';return}$('safe-display').textContent=inp.split('').join(' ');if(inp===G.safeCode){vibrate([100,50,100,50,200]);$('safe-feedback').textContent='‚úì A√ßƒ±ldƒ±!';$('safe-feedback').className='feedback correct';G.hasKey=true;showMsg('üîë Anahtar!',3000);setTimeout(()=>{closeSafe();updateHUD();renderRoom()},1500)}else{vibrate([100,50,100]);$('safe-feedback').textContent='‚úó Yanlƒ±≈ü!';$('safe-feedback').className='feedback wrong';$('safe-input').value=''}}
function closeSafe(){$('safe-modal').classList.remove('active')}

function hideInFurniture(f){vibrate(40);G.hiding=true;$('player').classList.add('hiding');$('hide-modal').classList.add('active')}
function exitHide(){vibrate(30);G.hiding=false;$('player').classList.remove('hiding');$('hide-modal').classList.remove('active')}
function updateHidingView(){const w=$('hide-warning'),p=$('peephole');if(G.gRoom===G.room&&dist(G.px,G.py,G.gx,G.gy)<140){w.classList.add('show');p.textContent='üë¥ Yakƒ±nda!';p.style.color='#e74c3c'}else{w.classList.remove('show');p.textContent='‚úì G√ºvende';p.style.color='var(--teal)'}}

function winChapter(){vibrate([100,50,100,50,200,100,300]);G.running=false;clearInterval(timerInterval);G.completedChapters[G.chapter-1]=true;saveProgress();const s=Math.floor((Date.now()-G.startTime)/1000),sc=Math.max(0,300-s)*10+Math.round(G.hp)*5+G.chapter*500;try{const sv=JSON.parse(localStorage.getItem('dedeEviProgress'))||{};if(!sv.highscore||sc>sv.highscore){sv.highscore=sc;localStorage.setItem('dedeEviProgress',JSON.stringify(sv))}}catch(e){}if(G.chapter<3){$('win-text').innerHTML=`B√∂l√ºm ${G.chapter} tamam!`;$('next-chapter-btn').style.display='block';$('next-chapter-btn').textContent=`B√ñL√úM ${G.chapter+1}`}else{$('win-text').innerHTML='<span style="color:var(--gold)">HEPSƒ∞ TAMAM!</span>';$('next-chapter-btn').style.display='none'}$('win-stats').innerHTML=`‚è±Ô∏è${formatTime(s)} ‚ù§Ô∏è${Math.round(G.hp)}`;$('win-score').textContent=`üèÜ ${sc}`;$('win-modal').classList.add('active')}
function gameOver(){vibrate([200,100,200,100,300]);G.running=false;clearInterval(timerInterval);const s=Math.floor((Date.now()-G.startTime)/1000);$('lose-stats').innerHTML=`‚è±Ô∏è${formatTime(s)} üìú${G.cluesFound}/3`;$('gameover-modal').classList.add('active')}
function nextChapter(){vibrate(50);G.chapter++;document.querySelectorAll('.modal').forEach(m=>m.classList.remove('active'));startGame()}
function restart(){vibrate(50);document.querySelectorAll('.modal').forEach(m=>m.classList.remove('active'));startGame()}
function toMenu(){vibrate(50);G.running=false;clearInterval(timerInterval);document.querySelectorAll('.modal').forEach(m=>m.classList.remove('active'));$('game').classList.remove('active');$('menu').classList.add('active');initMenu()}
function togglePause(){if(!G.running)return;vibrate(30);G.paused=!G.paused;if(G.paused){const s=Math.floor((Date.now()-G.startTime)/1000);$('pause-stats').innerHTML=`‚è±Ô∏è${formatTime(s)}<br>üìú${G.cluesFound}/3 üîë${G.hasKey?'‚úì':'‚úó'}`;$('pause-modal').classList.add('active')}else $('pause-modal').classList.remove('active')}

document.addEventListener('keydown',e=>{if(document.activeElement?.tagName==='INPUT'){if(e.key==='Escape'){document.activeElement.blur();if(G.currentPuzzle)closePuzzle()}return}const k=e.key.toLowerCase();if(k==='w'||k==='arrowup'){keys.w=true;e.preventDefault()}if(k==='s'||k==='arrowdown'){keys.s=true;e.preventDefault()}if(k==='a'||k==='arrowleft'){keys.a=true;e.preventDefault()}if(k==='d'||k==='arrowright'){keys.d=true;e.preventDefault()}if(k==='shift')keys.shift=true;if(k==='e'||k===' '){e.preventDefault();interact()}if(k==='escape'){e.preventDefault();if(G.hiding)exitHide();else if(G.currentPuzzle)closePuzzle();else togglePause()}});
document.addEventListener('keyup',e=>{if(document.activeElement?.tagName==='INPUT')return;const k=e.key.toLowerCase();if(k==='w'||k==='arrowup')keys.w=false;if(k==='s'||k==='arrowdown')keys.s=false;if(k==='a'||k==='arrowleft')keys.a=false;if(k==='d'||k==='arrowright')keys.d=false;if(k==='shift')keys.shift=false});

function initMobileControls(){
    const z=$('joystick-zone'),k=$('joystick-knob');if(!z||!k)return;let sX,sY;
    function hS(e){e.preventDefault();const t=e.touches?e.touches[0]:e,r=z.getBoundingClientRect();sX=r.left+r.width/2;sY=r.top+r.height/2;joystick.active=true}
    function hM(e){if(!joystick.active)return;e.preventDefault();const t=e.touches?e.touches[0]:e;let dx=t.clientX-sX,dy=t.clientY-sY;const mD=32,d=Math.sqrt(dx*dx+dy*dy);if(d>mD){dx=(dx/d)*mD;dy=(dy/d)*mD}joystick.dx=dx/mD;joystick.dy=dy/mD;k.style.transform=`translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`}
    function hE(e){e.preventDefault();joystick.active=false;joystick.dx=0;joystick.dy=0;k.style.transform='translate(-50%,-50%)'}
    z.addEventListener('touchstart',hS,{passive:false});z.addEventListener('touchmove',hM,{passive:false});z.addEventListener('touchend',hE,{passive:false});z.addEventListener('touchcancel',hE,{passive:false});
    $('btn-action')?.addEventListener('touchstart',e=>{e.preventDefault();interact()},{passive:false});
    const br=$('btn-run');if(br){br.addEventListener('touchstart',e=>{e.preventDefault();mobileRun=true;br.style.transform='scale(0.9)'},{passive:false});br.addEventListener('touchend',e=>{e.preventDefault();mobileRun=false;br.style.transform=''},{passive:false});br.addEventListener('touchcancel',()=>{mobileRun=false;br.style.transform=''},{passive:false})}
    $('pause-btn')?.addEventListener('touchstart',e=>{e.preventDefault();togglePause()},{passive:false});
}

document.addEventListener('DOMContentLoaded',()=>{
    $('continue-intro').onclick=()=>{vibrate(50);$('intro-screen').classList.add('hidden');$('menu').classList.add('active');initMenu()};
    $('start-btn').onclick=startGame;
    $('puz-submit').onclick=submitPuzzle;$('puz-hint-btn').onclick=showPuzzleHint;$('puz-close').onclick=closePuzzle;$('puz-input').onkeypress=e=>{if(e.key==='Enter')submitPuzzle()};
    $('safe-submit').onclick=submitSafe;$('safe-close').onclick=closeSafe;$('safe-input').onkeypress=e=>{if(e.key==='Enter')submitSafe()};
    $('exit-hide-btn').onclick=exitHide;$('pause-btn').onclick=togglePause;
    $('resume-btn').onclick=()=>{G.paused=false;$('pause-modal').classList.remove('active')};
    $('restart-btn').onclick=restart;$('quit-btn').onclick=toMenu;$('retry-btn').onclick=restart;$('menu-btn1').onclick=toMenu;
    $('next-chapter-btn').onclick=nextChapter;$('menu-btn2').onclick=toMenu;
    initMobileControls();
    document.addEventListener('touchend',e=>{const n=Date.now();if(n-(document.lastTouchEnd||0)<300)e.preventDefault();document.lastTouchEnd=n},{passive:false});
    document.addEventListener('contextmenu',e=>e.preventDefault());
});
if('serviceWorker'in navigator)navigator.serviceWorker.register('sw.js').catch(()=>{});
</script>
</body>
</html>
